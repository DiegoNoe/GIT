<!DOCTYPE html>
<html lang="en" style="background-color: white;">
<head>
	<title>Registro</title>

	<meta charset="utf-8">
    <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
	<script language="javascript" type="text/javascript" src="defiant.min.js"></script>
	
	<script>
		var config = {
			apiKey: "AIzaSyDrVZ3499rhvfFpxfRbU-wqJ-ZUN0-_ez0",
			authDomain: "cremeria-imperial.firebaseapp.com",
			databaseURL: "https://cremeria-imperial.firebaseio.com",
			projectId: "cremeria-imperial",
			storageBucket: "cremeria-imperial.appspot.com",
			messagingSenderId: "445465872507"
		};

		firebase.initializeApp(config);
		var timeouts = {};
		var database = firebase.database().ref('employees/');
		database.once('value', function (snapshot) {
			loadEmployees(snapshot.val());
		});

		database.on('child_changed', function (snapshot) {
			if(snapshot.val()) {
				var listItem = $('#dynamic-list').find('#' + snapshot.key);
				var ppaverage = 0;
				if(snapshot.val().nproducts != 0)
					ppaverage = ((snapshot.val().ttime / 1000) / snapshot.val().nproducts).toFixed(1);
				listItem.children().eq(1).text(ppaverage);
				listItem.children().eq(2).text(snapshot.val().norders);

				//sort
			}
		});


	</script>

	<style>

		@font-face {
            font-family: GillSansMTCondensedBold;
            font-style: normal;
            src: url(GillSansMTCondensedBold.ttf);
        }

		.container-fluid {
			font-family: GillSansMTCondensedBold;
			margin-left: 1%;
			margin-right: 1%;
			margin-top: 1.5%;
			position: relative;
		}

		#addEmployeeModal {
			font-family: GillSansMTCondensedBold;
			font-size: 25px;
		}
		
		#addEmployeeModalLabel {
			font-size: 27px;
		}

		.modal-body {
			padding-top: 5px;
		}

		#verificationMessage {
			font-size: 16px;
		}

		#dynamic-list {
			height: 640px;
			overflow: hidden;
			overflow-y: scroll;
		}

		#addNewEmployeeDBForm input{
			font-size: 17px;
		}

		#addNewEmployeeDBForm select{
			font-size: 17px;
		}

		#addNewEmployeeDBForm label{
			font-size: 18px;
		}

		.employee-row {
			margin-left: 0px;
			margin-right: 0px;
			padding-left: 12px; 
			padding-right: 12px;
		}

		.employee-name {
			font-size: 26px;
			line-height: 32px;
		}

		.employee-id {
			font-size: 26px;
			line-height: 32px;
		}

		.btn-modal {
			font-size: 20px;
			line-height: 18px;
		}

		.form-control:focus {
			border-color: rgb(239, 154, 154);
			box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(255, 0, 0, 0.6);
		}

		.list-group-item {
			padding-top: 4px;
			padding-bottom: 4px;
			padding-left: 12px;
			color: #444444;
		}

		.headTitle {
			border: none;
		}

	</style>
</head>

<body style="zoom: 100%; background-color: white; overflow: hidden;">
	<div class="alert alert-danger" style="display: none" id="noConnectionAlert" role="alert">
		<strong>No hay conexión.</strong> Verifica la conexión wifi.
	</div>
	<div class="container-fluid" style="background-color: white;">
		<div class="row"> 
			<h1 class="modal-title col-xs-8" style="margin-bottom:1.5%; margin-top:.5px">REGISTRO</h1>
			<div class="col-xs-4">
				<!-- <button onclick="addEmployeeModal();" class="btn btn-success" style="float: right; margin-top: 8px; margin-left: 10px; padding-left: 8.4px; padding-top: 7px; height: 34px; width: 34px; font-size: 25px; line-height: 10px;">+</button> -->
				<button onclick="sortEmployees(event);" class="btn btn-success" id="orderButton" style="float: right; margin-top: 8px; margin-left: 10px; padding-left: 10px; padding-top: 2.5px; height: 34px; width: 34px; font-size: 20px;">#</button>
			</div>
		</div>
		<div class="list-group-item row employee-row headTitle">
			<h2 class="col-xs-4 employee-name" style="padding: 0px; margin: 0px; padding-left: 0px;"> EMPLEADO </h2>
			<h2 class="col-xs-5 employee-name" style="padding: 0px; margin: 0px; padding-left: 10px;"> PROMEDIO P/P </h2>
			<h2 class="col-xs-3 employee-id" style="padding: 0px; margin: 0px; padding-left: 5px;"> #NOTAS </h2>
		</div>
		<ul id="dynamic-list" class="list-group" style="display:block;"> </ul>
	</div>

	<div class="modal fade" id="addEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">

				<!-- modal title -->
				<div class="modal-header">
					<h4 class="modal-title" id="addEmployeeModalLabel">AGREGAR EMPLEADO</h4>
				</div>
				<div class="modal-body">
					<form id="addNewEmployeeDBForm">
						<!-- form -->
						<div class="form-group">
							<!-- error message div -->
							<label id="verificationMessage" style="color: red;"></label>
							<div class="row" style="margin-bottom: 0px;">
								<!-- name -->
								<div class="col-xs-6">
									<label for="nameInput">NOMBRE</label>
									<input oninput="this.value = this.value.toUpperCase()" class="form-control" type="text" maxlength="9" placeholder="NOMBRE"
										required>
								</div>
                                <!-- pronunciation -->
                                <div class="col-xs-6">
									<label for="pronunciationInput">PRONUNCIACIÓN</label>
									<input oninput="this.value = this.value.toUpperCase()" class="form-control" type="text" maxlength="9" placeholder="PRONUNCIACIÓN"
									required>
                                </div>
							</div>
							
							<div class="row">
								<!-- id -->
								<div class="col-xs-3">
									<label for="IDInput">CLAVE</label>
									<input id="inputID" oninput="this.value = this.value.toUpperCase()"
										class="form-control" type="number" placeholder="CLAVE" required>
								</div>
                                <!-- sigma -->
                                <div class="col-xs-2">
                                    <label for="priceInput">SIGMA</label>
                                    <input class="form-control" style="width: 24px; margin-top: 0px;" type="checkbox" style="margin-top: 0px;">
								</div>
							</div>
						</div>
					</form>
				</div>
				<!-- modal interface buttons (delete is hidden when "add new product" view is active) -->
				<div class="modal-footer" style="text-align: center">
					<button type="button" style="font-size: 17px" class="btn btn-secondary btn-modal" data-dismiss="modal">CANCELAR</button>
					<button type="button" style="font-size: 17px" id="deleteButton" class="btn btn-danger btn-modal" data-dismiss="modal" onclick="deleteEmployeeDB();" style="display: none">ELIMINAR</button>
					<button type="button" style="font-size: 17px" class="btn btn-success btn-modal" id="saveButton" data-type="newEmployee" onclick="verificateNewEmployee();">GUARDAR</button>
				</div>
			</div>
		</div>
	</div>

	<script>

		checkConnection();

		function loadEmployees(employeesSnapshot) {
			$.each(employeesSnapshot, function(index, value) {
				$('#dynamic-list').append(formatListItem(value, index));				
			});
			//sort
		}

		function formatListItem(employee, id) {
			var ppaverage = 0;
			if(employee.nproducts != 0)
				ppaverage = ((employee.ttime / 1000) / employee.nproducts).toFixed(1);

			var employeeListItem =
				'<li class="list-group-item row employee-row" id="' + id + '">' +
					'<h2 class="col-xs-4 employee-name" style="padding: 0px; margin: 0px; padding-left: 0px;">' + id + '</h2>' +
					'<h2 class="col-xs-5 employee-name" style="padding: 0px; margin: 0px; padding-left: 10px;">' + ppaverage + '</h2>' +
					'<h2 class="col-xs-3 employee-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + employee.norders + '</h2>' +
				'</li>';
			
			return employeeListItem;
		}
		
		function sortEmployees(event) {
			if(event.target.innerHTML == "#"){
				sortList(document.getElementById('dynamic-list'), "numerical");
				event.target.innerHTML = "A";
			} else if(event.target.innerHTML == "A"){
				sortList(document.getElementById('dynamic-list'), "alphabetical");
				event.target.innerHTML = "#";
			}
		}

		function sortList(ul, type){
			var new_ul = ul.cloneNode(false);
			var lis = [];
			for(var i = ul.childNodes.length; i--;){
				if(ul.childNodes[i].nodeName === 'LI')
					lis.push(ul.childNodes[i]);
			}

			lis.sort(function(a, b){
				if(type == "numerical")
					return parseInt(a.childNodes[2].textContent , 10) - 
						parseInt(b.childNodes[2].textContent , 10);
				else if (type == "alphabetical")
					return a.childNodes[0].textContent > b.childNodes[0].textContent;
				return;
			});

			for(var i = 0; i < lis.length; i++)
				new_ul.appendChild(lis[i]);
			ul.parentNode.replaceChild(new_ul, ul);
		}
		
		//No connections alert
		function checkConnection() {
			var connectedRef = firebase.database().ref(".info/connected");
			connectedRef.on("value", function(snap) {
				if (snap.val() === true) document.getElementById("noConnectionAlert").style.display = "none";
				else document.getElementById("noConnectionAlert").style.display = "block";
			});
		}

	</script>
</body>