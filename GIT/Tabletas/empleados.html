<!DOCTYPE html>
<html lang="en" style="background-color: white;">
<head>
	<title>Empleados</title>

	<meta charset="utf-8">
    <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">

	<!-- local js resources -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
	<script language="javascript" type="text/javascript" src="defiant.min.js"></script>
	
	<script>
		var config = {
			apiKey: "AIzaSyDrVZ3499rhvfFpxfRbU-wqJ-ZUN0-_ez0",
			authDomain: "cremeria-imperial.firebaseapp.com",
			databaseURL: "https://cremeria-imperial.firebaseio.com",
			projectId: "cremeria-imperial",
			storageBucket: "cremeria-imperial.appspot.com",
			messagingSenderId: "445465872507"
		};

		firebase.initializeApp(config);
		var database = firebase.database().ref('empleados/');
		database.on('value', function (snapshot) {
			loadEmployees();
		});

		var employeesSnapshot;

	</script>

	<style>

		@font-face {
            font-family: GillSansMTCondensedBold;
            font-style: normal;
            src: url(GillSansMTCondensedBold.ttf);
        }

		.container-fluid {
			font-family: GillSansMTCondensedBold;
			margin-left: 1%;
			margin-right: 1%;
			margin-top: 1.5%;
			position: relative;
		}

		#addEmployeeModal {
			font-family: GillSansMTCondensedBold;
			font-size: 25px;
		}
		
		#addEmployeeModalLabel {
			font-size: 27px;
		}

		.modal-body {
			padding-top: 5px;
		}

		#verificationMessage {
			font-size: 16px;
		}

		#dynamic-list {
			height: 640px;
			overflow: hidden;
			overflow-y: scroll;
		}

		#addNewEmployeeDBForm input{
			font-size: 17px;
		}

		#addNewEmployeeDBForm select{
			font-size: 17px;
		}

		#addNewEmployeeDBForm label{
			font-size: 18px;
		}

		.employee-row {
			margin-left: 0px;
			margin-right: 0px;
			padding-left: 12px; 
			padding-right: 12px;
		}

		.employee-name {
			font-size: 26px;
			line-height: 32px;
		}

		.employee-id {
			font-size: 26px;
			line-height: 32px;
		}

		.btn-modal {
			font-size: 20px;
			line-height: 18px;
		}

		.form-control:focus {
			border-color: rgb(239, 154, 154);
			box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(255, 0, 0, 0.6);
		}

		.list-group-item {
			padding-top: 4px;
			padding-bottom: 4px;
			padding-left: 12px;
			color: #444444;
		}

		.headTitle {
			border: none;
		}

	</style>
</head>

<body style="zoom: 100%; background-color: white; overflow: hidden;">
	<div class="alert alert-danger" style="display: none" id="noConnectionAlert" role="alert">
		<strong>No hay conexión.</strong> Los cambios que hagas no se verán reflejados en la base de datos.
	</div>
	<div class="container-fluid" style="background-color: white;">
		<div class="row"> 
			<h1 class="modal-title col-xs-8" style="margin-bottom:1.5%; margin-top:.5px"> EMPLEADOS</h1>
			<div class="col-xs-4">
				<button onclick="addEmployeeModal();" class="btn btn-success" style="float: right; margin-top: 8px; margin-left: 10px; padding-left: 8.4px; padding-top: 7px; height: 34px; width: 34px; font-size: 25px; line-height: 10px;">+</button>
				<button onclick="sortEmployees(event);" class="btn btn-success" id="orderButton" style="float: right; margin-top: 8px; margin-left: 10px; padding-left: 10px; padding-top: 2.5px; height: 34px; width: 34px; font-size: 20px;">#</button>
			</div>
		</div>
		<div class="list-group-item row employee-row headTitle">
			<h2 class="col-xs-4 employee-name" style="padding: 0px; margin: 0px; padding-left: 0px;"> NOMBRE </h2>
			<h2 class="col-xs-5 employee-name" style="padding: 0px; margin: 0px; padding-left: 10px;"> PRONUN.</h2>
			<h2 class="col-xs-3 employee-id" style="padding: 0px; margin: 0px; padding-left: 5px;"> CLAVE </h2>
		</div>
		<ul id="dynamic-list" class="list-group" style="display:block;"> </ul>
	</div>

	<div class="modal fade" id="addEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">

				<!-- modal title -->
				<div class="modal-header">
					<h4 class="modal-title" id="addEmployeeModalLabel">AGREGAR EMPLEADO</h4>
				</div>
				<div class="modal-body">
					<form id="addNewEmployeeDBForm">
						<!-- form -->
						<div class="form-group">
							<!-- error message div -->
							<label id="verificationMessage" style="color: red;"></label>
							<div class="row" style="margin-bottom: 0px;">
								<!-- name -->
								<div class="col-xs-6">
									<label for="nameInput">NOMBRE</label>
									<input oninput="this.value = this.value.toUpperCase()" class="form-control" type="text" maxlength="9" placeholder="NOMBRE"
										required>
								</div>
                                <!-- pronunciation -->
                                <div class="col-xs-6">
									<label for="pronunciationInput">PRONUNCIACIÓN</label>
									<input oninput="this.value = this.value.toUpperCase()" class="form-control" type="text" maxlength="9" placeholder="PRONUNCIACIÓN"
									required>
                                </div>
							</div>
							
							<div class="row">
								<!-- id -->
								<div class="col-xs-3">
									<label for="IDInput">CLAVE</label>
									<input id="inputID" oninput="this.value = this.value.toUpperCase()"
										class="form-control" type="number" placeholder="CLAVE" required>
								</div>
                                <!-- sigma -->
                                <div class="col-xs-2">
                                    <label for="priceInput">SIGMA</label>
                                    <input class="form-control" style="width: 24px; margin-top: 0px;" type="checkbox" style="margin-top: 0px;">
								</div>
							</div>
						</div>
					</form>
				</div>
				<!-- modal interface buttons (delete is hidden when "add new product" view is active) -->
				<div class="modal-footer" style="text-align: center">
					<button type="button" style="font-size: 17px" class="btn btn-secondary btn-modal" data-dismiss="modal">CANCELAR</button>
					<button type="button" style="font-size: 17px" id="deleteButton" class="btn btn-danger btn-modal" data-dismiss="modal" onclick="deleteEmployeeDB();" style="display: none">ELIMINAR</button>
					<button type="button" style="font-size: 17px" class="btn btn-success btn-modal" id="saveButton" data-type="newEmployee" onclick="verificateNewEmployee();">GUARDAR</button>
				</div>
			</div>
		</div>
	</div>

	<script>

		checkConnection();

		function loadEmployees() {
			database.once('value', function(snapshot) {
				employeesSnapshot = snapshot.val();
			}).then(function() {
				var employeesNames = [];
				var employeesPronunciation = [];
				var employeesID = [];
				$.each(employeesSnapshot, function(key, value) {
					employeesNames.push(key);
					employeesPronunciation.push(value.substring(0, value.length - 2));
					employeesID.push(value.substring(value.length - 2, value.length));
				});
				populateEmployeesList(employeesNames, employeesPronunciation, employeesID);
			});
		}
		
		function populateEmployeesList(names, pronunciations, id) {
			$('#dynamic-list').empty();
			names.forEach(function (name, i){
				var sigmaEmployee = false;
				if(pronunciations[i].charAt(0) == 0) {
					sigmaEmployee = true;
					pronunciations[i] = pronunciations[i].substring(1, pronunciations[i].length);
				}
				var employeeListItem =
				'<li class="list-group-item row employee-row">' +
					'<h2 class="col-xs-4 employee-name" style="padding: 0px; margin: 0px; padding-left: 0px;">' + name + '</h2>' +
					'<h2 class="col-xs-5 employee-name" style="padding: 0px; margin: 0px; padding-left: 10px;">' + pronunciations[i] + '</h2>' +
					'<h2 class="col-xs-2 employee-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + id[i] + '</h2>' +
					'<button type="button" class="col-xs-1 btn glyphicon glyphicon-pencil" style="background-color:white; padding-top:2px;" onclick="editEmployeeModal(event)"' + 
						'data-name="' + name + '" data-pronunciation="' + pronunciations[i] + '" data-sigma="' + sigmaEmployee + '" data-id="' + id[i] + '">' + '</button>' + 
				'</li>';
										
				$('#dynamic-list').append(employeeListItem);
				//$("#dynamic-list").on("click", "button", function(e) {$(this).remove();});
				
			});

			if($('#orderButton').text() == "A")
				sortList(document.getElementById('dynamic-list'), "numerical");
		}
		
		function sortEmployees(event) {
			if(event.target.innerHTML == "#"){
				sortList(document.getElementById('dynamic-list'), "numerical");
				event.target.innerHTML = "A";
			} else if(event.target.innerHTML == "A"){
				sortList(document.getElementById('dynamic-list'), "alphabetical");
				event.target.innerHTML = "#";
			}
		}

		function sortList(ul, type){
			var new_ul = ul.cloneNode(false);
			var lis = [];
			for(var i = ul.childNodes.length; i--;){
				if(ul.childNodes[i].nodeName === 'LI')
					lis.push(ul.childNodes[i]);
			}

			lis.sort(function(a, b){
				if(type == "numerical")
					return parseInt(a.childNodes[2].textContent , 10) - 
						parseInt(b.childNodes[2].textContent , 10);
				else if (type == "alphabetical")
					return a.childNodes[0].textContent > b.childNodes[0].textContent;
				return;
			});

			for(var i = 0; i < lis.length; i++)
				new_ul.appendChild(lis[i]);
			ul.parentNode.replaceChild(new_ul, ul);
		}
		
        //edit or delete product modal values
        function editEmployeeModal(event) {
            document.getElementById("addEmployeeModalLabel").innerHTML = "EDITAR EMPLEADO";
            document.getElementById("deleteButton").style.display = "inline";
            document.getElementById("verificationMessage").innerHTML = "";

            var form = document.getElementById("addNewEmployeeDBForm");
            //{name:0, pronunciation:1, id:2, sigma:3}
            form.elements[0].value = event.target.getAttribute("data-name");
            form.elements[1].value = event.target.getAttribute("data-pronunciation");
            form.elements[2].value = event.target.getAttribute("data-id");
			form.elements[3].checked = event.target.getAttribute("data-sigma") == "true";
			
            //sets buttons inner values
            $('#saveButton').data("type", "editEmployee");
			$('#saveButton').data("name", form.elements[0].value);
			$('#saveButton').data("id", form.elements[2].value);
			
            $('#addEmployeeModal').modal('show');
		}
		
        //sets modal to add product view
        function addEmployeeModal() {
            document.getElementById("addEmployeeModalLabel").innerHTML = "AGREGAR EMPLEADO";
            document.getElementById("deleteButton").style.display = "none";
            document.getElementById("verificationMessage").innerHTML = "";
            document.getElementById("addNewEmployeeDBForm").reset();

            $('#saveButton').data("type", "newEmployee");
            $('#addEmployeeModal').modal('show');
        }

        //verificates input of modal form
        function verificateNewEmployee() {
            var messageLabel = document.getElementById("verificationMessage");
            var form = document.getElementById("addNewEmployeeDBForm");
			var verificated = true;

			var employeesNames = [];
			var employeesPronunciation = [];
			var employeesID = [];
			$.each(employeesSnapshot, function(key, value) {
				employeesNames.push(key);
				if(value.substring(0, 1) == 0)
					employeesPronunciation.push(value.substring(1, value.length - 2));
				employeesPronunciation.push(value.substring(0, value.length - 2));
				employeesID.push(value.substring(value.length - 2, value.length));
			});

			if(form.elements[2].value < 10 && form.elements[2].value > 0 && form.elements[2].value.charAt(0) != 0)
				form.elements[2].value = "0" + form.elements[2].value;
			
            //checks for blanks
            var inputs = new Array(4);
            //{name:0, pronunciation:1, id:2, sigma:3}
            for (var i = 0; i < inputs.length; i++) {
				if(i == 3)
					inputs[i] = form.elements[i].checked;
				else {
					inputs[i] = form.elements[i].value;
					if (inputs[i] == "") {
						messageLabel.innerHTML = "LLENA TODOS LOS CAMPOS.";
						verificated = false;
						break;
					}
				}
            }

            //checks for valid id
            if (form.elements[2].value < 1 || form.elements[2].value > 99) {
                messageLabel.innerHTML = "LA CLAVE DEBE DE SER ENTRE 01 - 99";
                verificated = false;
            }

            //checks for existing names
            if (form.elements[0].value != "") {
				if ($('#saveButton').data("type") == "newEmployee") {
					if (employeesNames.includes(form.elements[0].value)) {
						messageLabel.innerHTML = "EL NOMBRE YA EXISTE, INTENTA UNO DIFERENTE.";
						verificated = false;
					}
				} else if ($('#saveButton').data("type") == "editEmployee") {
					if (employeesNames.includes(form.elements[0].value) && form.elements[0].value != $('#saveButton').data("name")) {
						messageLabel.innerHTML = "EL NOMBRE YA EXISTE, INTENTA UNO DIFERENTE.";
						verificated = false;
					}
				}
			}
			
			//checks for existing IDs
            if (form.elements[2].value != "") {
				if ($('#saveButton').data("type") == "newEmployee") {
					if (employeesID.includes(form.elements[2].value.toString())) {
						messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
						verificated = false;
					}
				} else if ($('#saveButton').data("type") == "editEmployee") {
					if (employeesID.includes(form.elements[2].value.toString()) && form.elements[2].value != $('#saveButton').data("id")) {
						messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
						verificated = false;
					}
				}
			}

            //if everything is checked, upload form
            if (verificated) {
				console.log(inputs);
				
                addNewEmployeeDB(inputs);
                messageLabel.innerHTML = "";

                //if at edit product the id changes, deletes the old ids instance
                if ($('#saveButton').data("type") == "editEmployee")
					if ($('#saveButton').data("name") != form.elements[0].value)
						database.child($('#saveButton').data("name")).remove();

				//form.reset();
            }
        }

		//adds or updates a product to firebase
        function addNewEmployeeDB(inputs) {
			var pronunciationQuery = inputs[1] + inputs[2];
			if(inputs[3])
				pronunciationQuery = "0" + pronunciationQuery;
				
            firebase.database().ref('empleados/' + inputs[0]).set(pronunciationQuery).then(function () {
                $('#addEmployeeModal').modal('toggle');
			});
			
		}
		
		//deletes an existing product from the db
		function deleteEmployeeDB() {
			var name = document.getElementById("addNewEmployeeDBForm").elements[0].value;
			database.child(name).remove();
		}

		//No connections alert
		function checkConnection() {
			var connectedRef = firebase.database().ref(".info/connected");
			connectedRef.on("value", function(snap) {
				if (snap.val() === true) document.getElementById("noConnectionAlert").style.display = "none";
				else document.getElementById("noConnectionAlert").style.display = "block";
			});
		}

	</script>
</body>