<!DOCTYPE html>
<html lang="en" style="background-color: white;">
<head>
	<title>PEDIDOS</title>

	<meta charset="utf-8">
    <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">

	<!-- local js resources -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
	<script language="javascript" type="text/javascript" src="defiant.min.js"></script>
	
	<script>
		var config = {
			apiKey: "AIzaSyDrVZ3499rhvfFpxfRbU-wqJ-ZUN0-_ez0",
			authDomain: "cremeria-imperial.firebaseapp.com",
			databaseURL: "https://cremeria-imperial.firebaseio.com",
			projectId: "cremeria-imperial",
			storageBucket: "cremeria-imperial.appspot.com",
			messagingSenderId: "445465872507"
		};

		firebase.initializeApp(config);

		var firstsCounter = 0;
		var databaseFirsts = firebase.database().ref('process/firsts/');
		databaseFirsts.on('child_added', function (snapshot) {
			$('#dynamic-list-firsts').append(formatFirstsListItem(snapshot.val(), snapshot.key));
			$('#dynamic-list-firsts').children().last().data("hour", snapshot.val().hour);
			updateFElapsedTime($('#dynamic-list-firsts').children().last());
			
			firstsCounter++;
			updateCounter("firsts-counter-label", firstsCounter);
		});
		databaseFirsts.on('child_removed', function (snapshot) {
			var removedOrder = $('#dynamic-list-firsts').children().filter(function() {
				return $(this).data("hour") == snapshot.val().hour;
			});
			removedOrder.remove();
			
			firstsCounter--;
			updateCounter("firsts-counter-label", firstsCounter);
		});
		
		var secondsCounter = 0;
		var databaseSeconds = firebase.database().ref('process/seconds/');
		databaseSeconds.on('child_added', function (snapshot) {
			$('#dynamic-list-seconds').append(formatSecondsListItem(snapshot.val(), snapshot.key));
			$('#dynamic-list-seconds').children().last().data("hour", snapshot.val().hour);
			updateSElapsedTime($('#dynamic-list-seconds').children().last(), snapshot.val().nproducts);

			if(snapshot.val().thour > 0)  {
				var finishedOrder = $('#dynamic-list-seconds').children().filter(function() {
					return $(this).data("hour") == snapshot.val().hour;
				});
				finishedOrder.css("background-color", "#00B74AEE");
				finishedOrder.css("color", "white");
			}
			
			secondsCounter++;
			updateCounter("seconds-counter-label", secondsCounter);
		});

		databaseSeconds.on('child_changed', function (snapshot) {
			if(snapshot.val().thour > 0)  {
				var finishedOrder = $('#dynamic-list-seconds').children().filter(function() {
					return $(this).data("hour") == snapshot.val().hour;
				});
				finishedOrder.css("background-color", "#00B74AEE");
				finishedOrder.css("color", "white");

				if(snapshot.val().semployee != "-" && snapshot.val().nproducts > 0) {
					firebase.database().ref('employees/' + snapshot.val().semployee).once("value", function(ssnapshot) {
						if(ssnapshot.val()){
							var localSsnapshot = ssnapshot.val();
							localSsnapshot.norders = localSsnapshot.norders + 1;
							localSsnapshot.nproducts = localSsnapshot.nproducts + snapshot.val().nproducts;
							localSsnapshot.ttime = localSsnapshot.ttime + (snapshot.val().thour - snapshot.val().shour);
							localSsnapshot.lastFinished = snapshot.val().thour;
							localSsnapshot.hasOrder = false;

							console.log("se supone que aqui cambio el employee");
							
							firebase.database().ref('employees/' + snapshot.val().semployee).set(localSsnapshot);
						}
					});
				}
			}
		});

		databaseSeconds.on('child_removed', function (snapshot) {
			var removedOrder = $('#dynamic-list-seconds').children().filter(function() {
				return $(this).data("hour") == snapshot.val().hour;
			});
			removedOrder.remove();
			
			secondsCounter--;
			updateCounter("seconds-counter-label", secondsCounter);
		});

		var thirdsCounter = 0;
		var databaseThirds = firebase.database().ref('process/thirds/');
		var waitingTimes = [];
		var sWaitingTimes10 = [], spWaitingTimes10 = [];
		var sWaitingTimes30 = [], spWaitingTimes30 = [];
		var sWaitingTimes50 = [], spWaitingTimes50 = [];
		//default
		var globalTPP = ["0.55", "0.45", "0.35"];

		databaseThirds.on('child_added', function (snapshot) {
			$('#dynamic-list-thirds').append(formatThirdsListItem(snapshot.val(), snapshot.key));
			$('#dynamic-list-thirds').children().last().data("hour", snapshot.val().hour);

			sortList('dynamic-list-thirds');

			if (snapshot.val().shour > 0 && snapshot.val().thour > 0 && snapshot.val().nproducts != 0) { 
				var mSinceFinished = (Date.now() - snapshot.val().thour) / (60 * 1000);
				var minutesOfAverage = 90;
				if (mSinceFinished <= minutesOfAverage) {
					
					var orderWT = ((snapshot.val().shour - snapshot.val().hour) / (60 * 1000)).toFixed(2);
					var sOrderWT = ((snapshot.val().thour - snapshot.val().shour) / (60 * 1000)).toFixed(2);
					var spOrderWT = (((snapshot.val().thour - snapshot.val().shour) / snapshot.val().nproducts) / (60 * 1000)).toFixed(2);
	
					waitingTimes.push(orderWT);
					if(snapshot.val().nproducts <= 10) {
						sWaitingTimes10.push(sOrderWT);
						spWaitingTimes10.push(spOrderWT);
					} else if(snapshot.val().nproducts <= 30) {
						sWaitingTimes30.push(sOrderWT);
						spWaitingTimes30.push(spOrderWT); 
					} else {
						sWaitingTimes50.push(sOrderWT);
						spWaitingTimes50.push(spOrderWT); 
					}
					
					updateWaitingTime(waitingTimes);
					updateSWaitingTime(sWaitingTimes10, spWaitingTimes10, sWaitingTimes30, spWaitingTimes30, sWaitingTimes50, spWaitingTimes50);
					
					setTimeout(function() {
						if (waitingTimes.indexOf(orderWT) > -1)
							waitingTimes.splice(waitingTimes.indexOf(orderWT), 1);
						if(snapshot.val().nproducts <= 10) {
							if (sWaitingTimes10.indexOf(sOrderWT) > -1)
								sWaitingTimes10.splice(waitingTimes.indexOf(sOrderWT), 1);
							if (spWaitingTimes10.indexOf(spOrderWT) > -1)
								spWaitingTimes10.splice(waitingTimes.indexOf(spOrderWT), 1);
						} else if(snapshot.val().nproducts <= 30) {
							if (sWaitingTimes30.indexOf(sOrderWT) > -1)
								sWaitingTimes30.splice(waitingTimes.indexOf(sOrderWT), 1);
							if (spWaitingTimes30.indexOf(spOrderWT) > -1)
								spWaitingTimes30.splice(waitingTimes.indexOf(spOrderWT), 1);
						} else {
							if (sWaitingTimes50.indexOf(sOrderWT) > -1)
								sWaitingTimes50.splice(waitingTimes.indexOf(sOrderWT), 1);
							if (spWaitingTimes50.indexOf(spOrderWT) > -1)
								spWaitingTimes50.splice(waitingTimes.indexOf(spOrderWT), 1);
						}

						updateWaitingTime(waitingTimes);
						updateSWaitingTime(sWaitingTimes10, spWaitingTimes10, sWaitingTimes30, spWaitingTimes30, sWaitingTimes50, spWaitingTimes50);
					}, (minutesOfAverage - Math.trunc(mSinceFinished)) * 60 * 1000);
				}
			}

			if(snapshot.val().iftomorrow) {
				var localST = snapshot.val();
				localST.iftomorrow = false;
				localST.ifyesterday = true;
				firebase.database().ref('process/tomorrow/' + snapshot.key).set(localST);
			}

			thirdsCounter++;
			updateCounter("thirds-counter-label", thirdsCounter);
		});

		databaseThirds.on('child_removed', function (snapshot) {
			var removedOrder = $('#dynamic-list-thirds').children().filter(function() {
				return $(this).data("hour") == snapshot.val().hour;
			});
			removedOrder.remove();

			thirdsCounter--;
			updateCounter("thirds-counter-label", thirdsCounter);
		});

		var databaseYesterday = firebase.database().ref('process/yesterday/');
		databaseYesterday.on('child_added', function (snapshot) {
			$('#dynamic-list-thirds').append(formatThirdsListItem(snapshot.val(), snapshot.key));
			$('#dynamic-list-thirds').children().last().data("hour", snapshot.val().hour);

			sortList('dynamic-list-thirds');

			thirdsCounter++;
			updateCounter("thirds-counter-label", thirdsCounter);
		});

		databaseYesterday.on('child_removed', function (snapshot) {
			var removedOrder = $('#dynamic-list-thirds').children().filter(function() {
				return $(this).data("hour") == snapshot.val().hour;
			});
			removedOrder.remove();

			thirdsCounter--;
			updateCounter("thirds-counter-label", thirdsCounter);
		});

		var employeesSnapshot = {};
		var databaseEmployees = firebase.database().ref('empleados/');
		databaseEmployees.on('value', function (snapshot) {
			employeesSnapshot = snapshot.val();
		});

		//scanner input productsRefID.split('.').join("")

	</script>

	<style>

		@font-face {
            font-family: GillSansMTCondensedBold;
            font-style: normal;
            src: url(GillSansMTCondensedBold.ttf);
        }

		.container-fluid {
			font-family: GillSansMTCondensedBold;
			padding-top: .5%;
		}

		#verificationMessage {
			font-size: 16px;
		}

		#dynamic-list-firsts {
			height: 500px;
			overflow: hidden;
			overflow-y: scroll;
		}

		#dynamic-list-seconds {
			height: 373px;
			overflow: hidden;
			overflow-y: scroll;
		}

		#dynamic-list-thirds {
			height: 970px;
			overflow: hidden;
			overflow-y: scroll;
		}

		.order-row {
			margin-left: 0px;
			margin-right: 0px;
			padding-left: 12px; 
			padding-right: 12px;
		}

		.order-row-title {
			margin-left: 0px;
			margin-right: 0px;
			padding-left: 12px; 
			padding-right: 12px;
		}

		.client-name {
			font-size: 22px;
			line-height: 30px;
		}

		.order-id {
			font-size: 22px;
			line-height: 30px;
		}

		.list-group-item {
			padding-top: 2px;
			padding-bottom: 2px;
			padding-left: 12px;
			color: #444444;
		}

		.order-circle::before {
			background-color:rgb(201, 0, 0);
			width: 1px;
			height: 34px;

			border-radius: 5px;
			border: 1px solid lightgray;
			position:absolute;
			z-index: -0;
			text-align: center;
			padding: 4px;
			margin: 10px;
			left: -8px;
			top: -7px;
		}

		.headTitle {
			border: none;
		}

		.scroll-button {
			background: transparent;
			border: none;
			position: absolute;
			z-index: 1000;
			cursor: none;
		}

	</style>
</head>

<body style="zoom: 100%; background-color: white; overflow: hidden;">
	<input id="inputScanner" onblur="focusOnBlur()" style="position: absolute; left: -9999px;" autofocus></input>
	<div class="alert alert-danger" style="display: none" id="noConnectionAlert" role="alert">
		<strong>No hay conexión.</strong> Verifica la conexión a internet.
	</div>
	
	<div class="row" style="margin-top: 4px;">
		<div class="container-fluid col-sm-9" style="background-color: white; padding-left: 1.5%; padding-right: .25%;">
			<div class="row" style="height: 52px;"> 
				<div class="modal-title col-xs-5" style="margin-bottom: 10px; margin-top:.5px; height: 20px;">
					<h1 class="modal-title" id="firsts-counter-label" style="border-radius: 5px; float: left; width: 50px; height: 51px; text-align: center; background-color: white; color: #444444; border-style: solid; border-width: 2px;">0</h1>
					<h1 class="modal-title">&nbsp;PEDIDOS POR SURTIR</h1>
				</div>
				<div class="modal-title col-xs-4" style="margin-bottom: 10px; margin-top:.5px; height: 20px; padding-left: 100px;">
					<h1 class="modal-title" id="waiting-times-label"></h1>
				</div>
				<div class="modal-title col-xs-3">
					<h1 class="modal-title" id="firsts-max-label" style="float: right; text-align: right;"></h1>
				</div>
				
			</div>
			<div class="list-group-item row order-row-title headTitle">
				<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 0px;">CLIENTE</h2>
				<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">TOTAL</h2>
				<h2 class="col-xs-2 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">PRODUCTOS</h2>
				<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">ANOTÓ</h2>
				<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">METODO</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">TOMADO</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">TIEMPO</h2>
			</div>
			<button class="scroll-button" type="button" style="width: 1370px; height: 220px; left: 10px; top: 80px;" onclick="scrollbPressed('dynamic-list-firsts', 'up')"></button>			
			<button class="scroll-button" type="button" style="width: 1370px; height: 220px; left: 10px; top: 370px" onclick="scrollbPressed('dynamic-list-firsts', 'down')"></button>
			<ul id="dynamic-list-firsts" class="list-group" style="display:block; margin-bottom: 12px;"> </ul>
			
			<div class="row" style="height: 52px;"> 
				<div class="modal-title col-xs-4" style="margin-bottom:0%; margin-top:0px; height: 20px;">
					<h1 class="modal-title" id="seconds-counter-label" style="border-radius: 5px; float: left; width: 50px; height: 52px; text-align: center; border-style: solid; border-width: 2px;">0</h1>
					<h1 class="modal-title">&nbsp;PEDIDOS SURTIENDO</h1>
				</div>
				<div class="modal-title col-xs-5" style="margin-bottom: 0px; margin-top:0px; height: 20px; padding-left: 60px;">
					<h1 class="modal-title" id="s-waiting-times-label"></h1>
				</div>
				<div class="modal-title col-xs-3" style="margin-bottom:0%; margin-top:0px;">
					<h1 class="modal-title" id="seconds-max-label" style="float: right; text-align: right; height: 40px;"></h1>
				</div>
			</div>
			<div class="list-group-item row order-row-title headTitle">
				<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 0px;">CLIENTE</h2>
				<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">TOTAL</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">PRODUCTOS</h2>
				<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">ANOTÓ</h2>
				<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">METODO</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">TOMADO</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">ESPERÓ</h2>
				<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">SURTE</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">SURTIENDO</h2>
				<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">TOTAL</h2>
			</div>
			<button class="scroll-button" type="button" style="width: 1370px; height: 180px; left: 10px; top: 670px;" onclick="scrollbPressed('dynamic-list-seconds', 'up')"></button>			
			<button class="scroll-button" type="button" style="width: 1370px; height: 180px; left: 10px; top: 900px" onclick="scrollbPressed('dynamic-list-seconds', 'down')"></button>
			<ul id="dynamic-list-seconds" class="list-group" style="display:block;"> </ul>
		</div>
		
		<div class="container-fluid col-sm-3" style="background-color: white; height: 1280px; padding-left: .5%; padding-right: 1.6%;">
			<div class="modal-title" style="margin-bottom: 0%; margin-top: 0px;">
				<h1 class="modal-title" id="thirds-counter-label" style="border-radius: 5px; float: left; width: 50px; height: 52px; text-align: center; border-style: solid; border-width: 2px;">0</h1>
				<h1 class="modal-title">&nbsp;PEDIDOS POR COBRAR</h1>
			</div>
			<div class="list-group-item row order-row-title headTitle" style="padding-bottom: 1px;">
				<h2 class="col-xs-9 client-name" style="padding: 0px; margin: 0px; padding-left: 0px;">CLIENTE</h2>
				<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 5px;">TOTAL</h2>
			</div>
			<button class="scroll-button" type="button" style="width: 385px; height: 400px; left: 10px; top: 80px;" onclick="scrollbPressed('dynamic-list-thirds', 'up')"></button>			
			<button class="scroll-button" type="button" style="width: 385px; height: 400px; left: 10px; top: 680px;" onclick="scrollbPressed('dynamic-list-thirds', 'down')"></button>
			<ul id="dynamic-list-thirds" class="list-group" style="display:block;"> </ul>
		</div>
	</div>
	
	<script>
		
		checkConnection();
		idleTimer();
		
		checkDayChange();
		window.setInterval(checkDayChange, 5*60*1000);

		$("#inputScanner").on('keyup', function (e) {
			if (e.keyCode == 13 && $("#inputScanner").val() != "")
				manageScannerInput();
		});

		function idleTimer() {
			var idleTime = 0;
			$(document).ready(function () {
				var idleInterval = setInterval(timerIncrement, 5000);
				$(this).mousemove(function (e) {
					idleTime = 0;
				});
			});

			function timerIncrement() {
				idleTime = idleTime + 1;
				if (idleTime > 5) {
					scrollbPressed("dynamic-list-firsts", "up");
					scrollbPressed("dynamic-list-seconds", "up");
				}
			}
		}

		function scrollbPressed(elementid, direction) {
			var element = document.getElementById(elementid);
			var step = 10;
			var speed = 5;
			var distance = 200;

			if(elementid == "dynamic-list-thirds") {
				distance = 600;
				speed = 2;
			}

			var scrollAmount = 0;
			var slideTimer = setInterval(function() {
				if(direction == 'down')
					element.scrollBy(0, step);
				else 
					element.scrollBy(0, -step);
				scrollAmount += step;
				if(scrollAmount >= distance){
					window.clearInterval(slideTimer);
				}
			}, speed);
		}

		function updateWaitingTime(waitingTimes) {
			var averageTime = getAverage(waitingTimes);
			
			if(averageTime == 0)
				$("#waiting-times-label").text("");
			else
				$("#waiting-times-label").text("PROMEDIO: " + (averageTime / 1).toFixed(1) + "M");
		}

		function updateSWaitingTime(sWaitingTimes10, spWaitingTimes10, sWaitingTimes30, spWaitingTimes30, sWaitingTimes50, spWaitingTimes50) {
			var averageTime = ((parseFloat(getAverage(sWaitingTimes10)) + parseFloat(getAverage(sWaitingTimes30)) + parseFloat(getAverage(sWaitingTimes50))) / 3 ).toFixed(1);
			var averageTimePP = ((parseFloat(getAverage(spWaitingTimes10)) + parseFloat(getAverage(spWaitingTimes30)) + parseFloat(getAverage(spWaitingTimes50))) / 3 ).toFixed(1);
			
			if(averageTime == 0)
				$("#s-waiting-times-label").text("");
			else
				$("#s-waiting-times-label").text("PROMEDIO: " + parseFloat(averageTime).toFixed(1) + "N " + parseFloat(averageTimePP).toFixed(1) + "P");
			
			firebase.database().ref('process/timing/tpp10').set(parseFloat(getAverage(spWaitingTimes10)).toFixed(2));
			firebase.database().ref('process/timing/tpp30').set(parseFloat(getAverage(spWaitingTimes30)).toFixed(2));
			firebase.database().ref('process/timing/tpp50').set(parseFloat(getAverage(spWaitingTimes50)).toFixed(2));
			globalTPP = [parseFloat(getAverage(spWaitingTimes10)).toFixed(2), parseFloat(getAverage(spWaitingTimes30)).toFixed(2), parseFloat(getAverage(spWaitingTimes50)).toFixed(2)];
		}

		function getAverage(array) {
			if(array.length == 0)
				return 1;
			
			array.sort();
			var tenP = Math.trunc(array.length * .1);

			var sum = 0;
			for (var i = tenP; i < array.length - tenP; i++)
				sum += parseFloat(array[i]);

			return parseFloat((sum / array.length).toFixed(2));
		}

		function updateCounter(id, counter) {
			$("#" + id).text(counter);
			if(id == "firsts-counter-label") {
				if(counter >= 5){
					$("#" + id).css("background-color", "rgba(216, 61, 52, 88%)");
					$("#" + id).css("color", "white");
					$("#" + id).css("border-style", "hidden");
				} else if(counter >= 3 && counter <= 4){
					$("#" + id).css("background-color", "rgba(255, 215, 0, 88%)");
					$("#" + id).css("color", "#444444");
					$("#" + id).css("border-style", "hidden");
				} else if(counter >= 0 && counter <= 2){
					$("#" + id).css("background-color", "white");
					$("#" + id).css("color", "#444444");
					$("#" + id).css("border-style", "solid");
				}
				
				uploadWOrders();
			}
			
			if(id == "thirds-counter-label") {
				if(counter.toString().length == 3)
				$("#thirds-counter-label").css("width", "65px");
				else
				$("#thirds-counter-label").css("width", "50px");
			}
		}
		
		function uploadWOrders() {
			var realCounter = 0;
			$("#dynamic-list-firsts").children().each(function( index ) {
				if($(this).children().eq(6).text() <= 20)
					realCounter++;
			});
			firebase.database().ref('process/timing/worders').set(realCounter);
			
			var rawCouter = $("#firsts-counter-label").text();
			firebase.database().ref('process/timing/rworders').set(rawCouter);
		}

        function focusOnBlur() {
            setTimeout(function() { $("#inputScanner").focus(); }, 0);
		}
		
		function isLetter(char) {
			return (/[a-zA-Z]/).test(char)		
		}

        function manageScannerInput() {
            var input = $("#inputScanner").val();
			$("#inputScanner").val("");
			
			input = input.replace(/[^A-Z0-9]/g,'');

			if(isLetter(input.charAt(0))) {
				//sino hubo clave, busco en seconds, si existe seteo la hora para cambiar el color.
				var orderid = input;
				firebase.database().ref('process/seconds/' + orderid).once("value", function(snapshot) {
					if(snapshot.val()) {
						var localsnapshot = snapshot.val();
						localsnapshot.thour = Date.now();
						
						firebase.database().ref('process/seconds/' + orderid).set(localsnapshot);
						//firebase.database().ref('process/seconds/' + orderid).remove();
					} else {
						//sino está en seconds, busco en firsts y seteo seconds. borro en firsts
						firebase.database().ref('process/firsts/' + orderid).once("value", function(snapshot) {
							if(snapshot.val()) {
								var localsnapshot = snapshot.val();
								localsnapshot.semployee = "-";
								localsnapshot.shour = Date.now();
								
								firebase.database().ref('process/seconds/' + orderid).set(localsnapshot).then(function () {
									firebase.database().ref('process/firsts/' + orderid).remove();
								});
							}
						});
					}
				});	
			} else {
				if(isLetter(input.charAt(1)))
					input = "0" + input;
				if(isLetter(input.charAt(2))) {
					var employeeid = input.slice(0, 2);
					var orderid = input.slice(2, input.length);	

					var semployeeName = getEmployeeNameByID(employeesSnapshot, employeeid);
					if(semployeeName != undefined) {
						//si el empleado existe y está en first, seteo seconds. borro en firsts
						firebase.database().ref('process/firsts/' + orderid).once("value", function(snapshot) {
							if(snapshot.val()) {
								var localsnapshot = snapshot.val();
								localsnapshot.semployee = semployeeName;
								localsnapshot.shour = Date.now();	
								
								//aqui
								firebase.database().ref('employees/' + semployeeName + "/hasOrder").set(true); 

								firebase.database().ref('process/seconds/' + orderid).set(localsnapshot).then(function () {
									firebase.database().ref('process/firsts/' + orderid).remove();
								});
							}
						});	
					} else if(employeeid == 99) {
						//si está en firsts, seteo thirds. borro firsts
						firebase.database().ref('process/firsts/' + orderid).once("value", function(snapshot) {
							if(snapshot.val()) {
								var localsnapshot = snapshot.val();
								firebase.database().ref('process/thirds/' + orderid).set(localsnapshot).then(function () {
									firebase.database().ref('process/firsts/' + orderid).remove();
								});
							} else {
								//si está en seconds, seteo first s. borro seconds
								firebase.database().ref('process/seconds/' + orderid).once("value", function(snapshot) {
									if(snapshot.val()) {
										var localsnapshot = snapshot.val();
										delete localsnapshot.shour;
										delete localsnapshot.thour;
										firebase.database().ref('process/firsts/' + orderid).set(localsnapshot).then(function () {
											firebase.database().ref('process/seconds/' + orderid).remove();
										});
									} else {
										//si está en thirds, seteo first s. borro thirds
										firebase.database().ref('process/thirds/' + orderid).once("value", function(snapshot) {
											if(snapshot.val()) {
												var localsnapshot = snapshot.val();
												localsnapshot.checked = false;
												delete localsnapshot.shour;
												delete localsnapshot.thour;
												firebase.database().ref('process/firsts/' + orderid).set(localsnapshot).then(function () {
													firebase.database().ref('process/thirds/' + orderid).remove();
												});
											} else {
												//si está en fourths, seteo first s. borro fourths
												firebase.database().ref('process/fourths/' + orderid).once("value", function(snapshot) {
													if(snapshot.val()) {
														var localsnapshot = snapshot.val();
														localsnapshot.checked = false;
														delete localsnapshot.shour;
														delete localsnapshot.thour;
														firebase.database().ref('process/firsts/' + orderid).set(localsnapshot).then(function () {
															firebase.database().ref('process/fourths/' + orderid).remove();
														});
													} 
												});	
											}
										});	
									}
								});
							}
						});
					}
				}
			}
        }

		function formatFirstsListItem(order, id) {
			var orderHour = new Date(order.hour);
			var diffMinutes = Math.trunc((new Date() - orderHour) / 60000);
			var backgroundColor = "white",
                color = "#444444";
			
			if(!order.ftotal)
				order.total = order.total + "~";
			
			if(order.ndiversity == "0") {
				order.nproducts = order.nproducts + " &#10003;"
				backgroundColor = "#00B74AEE";
                color = "white";
			} else if(order.ndiversity == "1" && !order.haspanela) {
				if((order.onlyafuera && order.nproducts <= 10) || (!order.onlyafuera && order.nproducts <= 2)) {
					order.nproducts = order.nproducts + " &#x21;"
					//backgroundColor = "#00B74AEE";
                	//color = "white";
				}
			}

			if(order.ordertype == "MOSTRADOR")
				order.ordertype = "MOST.";
			else if (order.ordertype == "TELEFONO")
				order.ordertype = "TEL.";
			else if (order.ordertype == "WHATSAPP")
				order.ordertype = "WHA.";

			var returnStatement = 
				'<li class="list-group-item row order-row" style="background-color: ' + backgroundColor + '; color: ' + color + ';">' +
					'<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 3px;">' + order.name + '</h2>' +
					'<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">$' + order.total + '</h2>' +
					'<h2 class="col-xs-2 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + order.nproducts + '</h2>' +
					'<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">' + order.femployee + '</h2>' +
					'<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">#'+ order.ncomputer + " " + order.ordertype + '</h2>' +
					'<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + orderHour.toLocaleString('en-US', {hour: 'numeric', minute: 'numeric', hour12: true}) + '</h2>' +
					'<div class="col-xs-1" style="padding: 0px; margin: 0px; padding-left: 5px;">' +  
						'<h2 class="order-id elapsed-time" style="width: 60px; margin: 0px 0px; float: left; clear: both;">' + diffMinutes + '</h2>' + 						
						'<div type="button" class="btn btn-sm" style="float: right; margin: 0px; height: 30px;" onclick="sendToThirds(&quot;' + id + '&quot;)">' +
							'<h4 class="glyphicon glyphicon-remove" style="margin-top: .75px;"></h4>' +
						'</div>' +
					'</div>' +
				'</li>';
			
			return returnStatement;
			//'<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + getEstimatedTime(order.nproducts) + '</h2>' +
		}

		function sendToThirds(orderid) {
			firebase.database().ref('process/firsts/' + orderid).once("value", function(snapshot) {
				if(snapshot.val()) {
					var localsnapshot = snapshot.val();
					localsnapshot.checked = true;
					firebase.database().ref('process/thirds/' + orderid).set(localsnapshot).then(function () {
						firebase.database().ref('process/firsts/' + orderid).remove();
					});
				} else {
					firebase.database().ref('process/seconds/' + orderid).once("value", function(snapshot) {
						if(snapshot.val()) {
							var localsnapshot = snapshot.val();
							localsnapshot.checked = true;
							firebase.database().ref('process/thirds/' + orderid).set(localsnapshot).then(function () {
								firebase.database().ref('process/seconds/' + orderid).remove();
							});
						} 
					});
				}
			});
		}

		function formatSecondsListItem(order, id) {
			var orderHour = new Date(order.hour);
			var diffMinutes = Math.trunc((new Date() - orderHour) / 60000);
			var diffMinutesSeconds = Math.trunc((new Date() - new Date(order.shour)) / 60000);

			var backgroundColor = "white",
                color = "#444444";

			if(!order.ftotal)
				order.total = order.total + "~";

			if(order.ordertype == "MOSTRADOR")
				order.ordertype = "MOST.";
			else if (order.ordertype == "TELEFONO")
				order.ordertype = "TEL.";
			else if (order.ordertype == "WHATSAPP")
				order.ordertype = "WHA.";
			
			var returnStatement = 
				'<li class="list-group-item row order-row" style="background-color: ' + backgroundColor + '; color: ' + color + ';">' +
					'<h2 class="col-xs-3 client-name" style="padding: 0px; margin: 0px; padding-left: 0px;">' + order.name + '</h2>' +
					'<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">$' + order.total + '</h2>' +
					'<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + order.nproducts + '</h2>' +
					'<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">' + order.femployee + '</h2>' +
					'<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">#' + order.ncomputer + " " + order.ordertype + '</h2>' +
					'<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + orderHour.toLocaleString('en-US', {hour: 'numeric', minute: 'numeric', hour12: true}) + '</h2>' +
					'<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + (diffMinutes - diffMinutesSeconds) + '</h2>' +
					'<h2 class="col-xs-1 client-name" style="padding: 0px; margin: 0px; padding-left: 10px;">' + order.semployee + '</h2>' +
					'<h2 class="col-xs-1 order-id seconds-elapsed-time" style="padding: 0px; margin: 0px; padding-left: 5px;">' + diffMinutesSeconds + '</h2>' +
					'<div class="col-xs-1" style="padding: 0px; margin: 0px; padding-left: 5px;">' +  
						'<h2 class="order-id elapsed-time" style="width: 60px; margin: 0px 0px; float: left; clear: both;">' + diffMinutes + '</h2>' + 						
						'<div type="button" class="btn btn-sm" style="float: right; margin: 0px; height: 30px;" onclick="sendToThirds(&quot;' + id + '&quot;)">' +
							'<h4 class="glyphicon glyphicon-remove" style="margin-top: .75px;"></h4>' +
						'</div>' +
					'</div>' +
				'</li>';
			return returnStatement;
			//'<h2 class="col-xs-1 order-id" style="padding: 0px; margin: 0px; padding-left: 5px;">' + getEstimatedTime(order.nproducts) + '</h2>' +
		}

		function formatThirdsListItem(order, id) {
			if(!order.ftotal)
				order.total = order.total + "~";
			
			var backgroundColor = "rgba(216, 61, 52, 88%)",
				color = "white";
			
			if(order.checked) {
				backgroundColor = "white";
				color = "#444444";
			}

			var iconVisibility = "none";
			var tomorrowIcon = "glyphicon-cloud-upload";

			if(order.iftomorrow)
				iconVisibility = "block";

			if(order.ifyesterday) {
				iconVisibility = "block";
				tomorrowIcon = "glyphicon-cloud-download";
			}
			
			var returnStatement = 
				'<li class="list-group-item row order-row" style="padding-right: 0px; background-color: ' + backgroundColor + '; color: ' + color + ';">' +
					'<div class="col-xs-8" style="padding: 0px; margin: 0px;">' + 
						'<h3 class="glyphicon ' + tomorrowIcon + '" style="padding: 0px; margin: 0px; float: left; width:30px; display: ' + iconVisibility + '"></h3>' + 
						'<h2 class="client-name" style="padding: 0px; margin: 0px; padding-left: 0px; float: left;">' + order.name + '</h2>' + 
					'</div>' +
					'<div class="col-xs-4" style="padding: 0px; margin: 0px; padding-left: 5px;">' +  
						'<h2 class="order-id elapsed-time" style="width: 90px; margin: 0px 0px; float: left; clear: both;">' + order.total + '</h2>' + 						
						'<div type="button" class="btn btn-sm" style="float: right; margin: 0px; height: 30px;" onclick="sendToFourths(&quot;' + id + '&quot;)">' +
							'<h4 class="glyphicon glyphicon-remove" style="margin-top: .75px;"></h4>' +
						'</div>' +
					'</div>' +
				'</li>';
			return returnStatement;
		}

		function sendToFourths(orderid) {
			firebase.database().ref('process/thirds/' + orderid).once("value", function(snapshot) {
				if(snapshot.val()) {
					var localsnapshot = snapshot.val();
					firebase.database().ref('process/fourths/' + orderid).set(localsnapshot).then(function () {
						firebase.database().ref('process/thirds/' + orderid).remove();
					});
				}
			});
		}

		function getEmployeeNameByID(object, value) {
			return Object.keys(object).find(key => object[key].slice(-2) === value);
		}


		//UPDATE combining timer and color
		function updateFElapsedTime(orderListItem) {
			var etField = orderListItem.find(".elapsed-time");
			
			if(orderListItem.css("background-color") != "rgba(0, 183, 74, 0.933)") {
				if(etField.text() > 4) {
					orderListItem.css("background-color", "rgba(216, 61, 52, 88%)");
					orderListItem.css("color", "white");						
				} else if(etField.text() > 2 && etField.text() <= 4) {
					orderListItem.css("background-color", "rgba(255, 215, 0, 88%)");
					orderListItem.css("color", "#444444");				
				}
			}
				
			var interval = setInterval(function() {
				if(etField.css('display') != "block")
					clearInterval(interval);
				etField.text(parseInt(etField.text()) + 1);
				
				if(orderListItem.css("background-color") != "rgba(0, 183, 74, 0.933)") {
					if(etField.text() > 4) {
					orderListItem.css("background-color", "rgba(216, 61, 52, 88%)");
					orderListItem.css("color", "white");						
					} else if(etField.text() > 2 && etField.text() <= 4) {
						orderListItem.css("background-color", "rgba(255, 215, 0, 88%)");
						orderListItem.css("color", "#444444");				
					}
				}
			}, 60000);
		}
		
		function updateSElapsedTime(orderListItem, nproducts) {
			var etField = orderListItem.find(".seconds-elapsed-time");
			var etSField = orderListItem.find(".elapsed-time");

			var expectedTime = getExpectedTime(nproducts);
			var oneThirdET = Math.floor(expectedTime * .34);

			//("prods:" + nproducts + " et:" + expectedTime);
			//("et 20%" + (Math.floor(expectedTime * .34)));

			//coloreada
			if(orderListItem.css("background-color") != "rgba(0, 183, 74, 0.933)") {
				if(etField.text() > expectedTime) {
					orderListItem.css("background-color", "rgba(216, 61, 52, 88%)");
					orderListItem.css("color", "white");				
				} else if(etField.text() > (expectedTime - oneThirdET) && etField.text() <= expectedTime) {
					orderListItem.css("background-color", "rgba(255, 215, 0, 88%)");
					orderListItem.css("color", "#444444");				
				} else if(etField.text() >= 0 && etField.text() <= (expectedTime - oneThirdET)) {
					orderListItem.css("background-color", "white");
					orderListItem.css("color", "#444444");				
				}
			}
				
			var interval = setInterval(function() {
				if(etField.css('display') != "block")
					clearInterval(interval);
				
				if(orderListItem.css("background-color") != "rgba(0, 183, 74, 0.933)") {
					etField.text(parseInt(etField.text()) + 1);
					etSField.text(parseInt(etSField.text()) + 1);
				
					if(etField.text() > (expectedTime + oneThirdET)) {
						orderListItem.css("background-color", "rgba(216, 61, 52, 88%)");
						orderListItem.css("color", "white");				
					} else if(etField.text() > expectedTime && etField.text() <= (expectedTime + oneThirdET)) {
						orderListItem.css("background-color", "rgba(255, 140, 0, 88%)");
						orderListItem.css("color", "white");				
					} else if(etField.text() > (expectedTime - oneThirdET) && etField.text() <= expectedTime) {
						orderListItem.css("background-color", "rgba(255, 215, 0, 88%)");
						orderListItem.css("color", "#444444");				
					} else if(etField.text() >= 0 && etField.text() <= (expectedTime - oneThirdET)) {
						orderListItem.css("background-color", "white");
						orderListItem.css("color", "#444444");				
					}
				}
			}, 60000);
		}

		function getExpectedTime(nproducts) {
            var time = 0;
            if(nproducts <= 10)
				time = nproducts * globalTPP[0];
            else if(nproducts <= 30)
                time = nproducts * globalTPP[1];
            else
                time = nproducts * globalTPP[2];

            return Math.ceil(time);
        }

		function increaseElapsedTime(orderListItem, className) {
			var etField = orderListItem.find("." + className);
				
			var interval = setInterval(function() {
				if(etField.css('display') != "block")
					clearInterval(interval);
				etField.text(parseInt(etField.text()) + 1);
			}, 60000);
		}

		function getEstimatedTime(nproducts) {
			//FUTURE calculate estimated order time
			return Math.trunc(nproducts / 2);
		}
		
		function updateMaxTimeFirsts() {			
			if($("#dynamic-list-firsts").children().first().children().eq(6).text())
				$("#firsts-max-label").text("MÁXIMO: " + $("#dynamic-list-firsts").children().first().children().eq(6).text() + "M");
			else
				$("#firsts-max-label").text("");
		}
		
		function updateMaxTimeSeconds() {			
			if($("#dynamic-list-seconds").children().first().children().eq(8).text()) {
				var employeeName = $("#dynamic-list-seconds").children().first().children().eq(7).text();
				var elapsedTime = $("#dynamic-list-seconds").children().first().children().eq(8).text();
				
				$("#seconds-max-label").text("MÁXIMO: " + employeeName + " " + elapsedTime + "M");
			}
			else
				$("#seconds-max-label").text("");
		}
		
		function sortList(ulname){
			ul = document.getElementById(ulname);
			var new_ul = ul.cloneNode(false);
			var lis = [];
			for(var i = ul.childNodes.length; i--;){
				if(ul.childNodes[i].nodeName === 'LI')
					lis.push(ul.childNodes[i]);
			}

			lis.sort(function(a, b){
				if(ulname == "dynamic-list-firsts") {
					return parseInt(b.childNodes[6].textContent , 10) - 
						parseInt(a.childNodes[6].textContent , 10);
				} else if(ulname == "dynamic-list-seconds") {
					return parseInt(b.childNodes[6].textContent , 10) - 
						parseInt(a.childNodes[6].textContent , 10);
				} else if(ulname == "dynamic-list-thirds") {
					return a.childNodes[0].textContent > 
						b.childNodes[0].textContent;
				}
			});

			for(var i = 0; i < lis.length; i++)
				new_ul.appendChild(lis[i]);
			ul.parentNode.replaceChild(new_ul, ul);
		}

		//global employees loop
		firebase.database().ref('employees').once("value", function(snapshot) { 
			if(snapshot.val()) {
				$.each(snapshot.val(), function(key, value) {
					firebase.database().ref('employees/' + key + '/resting').set(false);
				});
			}
		}); 
		

		function checkDayChange() {
            var now = new Date();
            var millisTill7pm = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 10, 0, 0) - now;
			
			if (millisTill7pm < 0) {
				firebase.database().ref('process/firsts').remove();
				firebase.database().ref('process/seconds').remove();
				firebase.database().ref('process/thirds').remove();
				firebase.database().ref('process/fourths').remove();
				firebase.database().ref('process/timing').remove();

				firebase.database().ref('employees').once("value", function(snapshot) { 
					if(snapshot.val()) {
						$.each(snapshot.val(), function(key, value) {
							firebase.database().ref('employees/' + key + '/norders').set(0);
							firebase.database().ref('employees/' + key + '/nproducts').set(0);
							firebase.database().ref('employees/' + key + '/ttime').set(0);
							firebase.database().ref('employees/' + key + '/lastFinished').set(0);
							firebase.database().ref('employees/' + key + '/ttBeingLazy').set(0);
							firebase.database().ref('employees/' + key + '/hasOrder').set(false);
							firebase.database().ref('employees/' + key + '/resting').set(false);
							firebase.database().ref('employees/' + key + '/nordersT').set(0);
							firebase.database().ref('employees/' + key + '/lastFinishedT').set(0);
							firebase.database().ref('employees/' + key + '/ttimeT').set(0);
						});
					}
				});

				firebase.database().ref('process/tomorrow/').once("value", function(snapshot) {
					if(snapshot.val()) {
						firebase.database().ref('process/yesterday/').set(snapshot.val()).then(function () {
							firebase.database().ref('process/tomorrow/').remove();
						});;
					}
				});
			}
        }

		var justOrdered = false;
		function checkConnection() {
			var connectedRef = firebase.database().ref(".info/connected");
			connectedRef.on("value", function(snap) {
				if (snap.val() === true) {
					document.getElementById("noConnectionAlert").style.display = "none";
					if(!justOrdered) {
						justOrdered = true;
						setTimeout(function() {
							sortList('dynamic-list-firsts');
							sortList('dynamic-list-seconds');
							
							updateMaxTimeFirsts();
							updateMaxTimeSeconds();
							var interval = setInterval(function() {
								updateMaxTimeFirsts();
								updateMaxTimeSeconds();
							}, 1000);	
						}, 500);
					}
				} else 
					document.getElementById("noConnectionAlert").style.display = "block";
			});
		}

	</script>
</body>