<!DOCTYPE html>
<html lang="es">

<head>
    <title>Entregas</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">

    <script language="javascript" type="text/javascript" src="jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="bootstrap.min.js"></script>
    <script language="javascript" type="text/javascript" src="firebase.js"></script>
    <script language="javascript" type="text/javascript" src="array_nombres.js"></script>
    <script language="javascript" type="text/javascript" src="aes.js"></script>

    <script>
        var config = {
            apiKey: "AIzaSyDrVZ3499rhvfFpxfRbU-wqJ-ZUN0-_ez0",
            authDomain: "cremeria-imperial.firebaseapp.com",
            databaseURL: "https://cremeria-imperial.firebaseio.com",
            projectId: "cremeria-imperial",
            storageBucket: "cremeria-imperial.appspot.com",
            messagingSenderId: "445465872507"
        };
        firebase.initializeApp(config);
        var aesEcb = new aesjs.ModeOfOperation.ecb(aesMethod);
    </script>

</head>

<body>
    <txt id="console"></txt>
    <input id="inputScanner" onblur="focusOnBlur()" style="position: absolute; left: -9999px;" autofocus></input>
    
    <script>

        var namesDictonary = {};
        populateDictonary(namesArray);

        checkDayChange();
        window.setInterval(checkDayChange, 5*60*1000);
        reloadOnUpdate();

        $("#inputScanner").on('keyup', function (e) {
            if (e.keyCode == 13 && $("#inputScanner").val() != "") {
                manageScannerInput();
            } 
        });

        function focusOnBlur() {
            setTimeout(function() { $("#inputScanner").focus(); }, 0);
        }

        function manageScannerInput() {
            var input = $("#inputScanner").val();
            $("#inputScanner").val("");
            var visualConsole = document.getElementById("console");
            visualConsole.innerHTML = input + "<br>" + visualConsole.innerHTML;

            var name = input.slice(1, input.length - 1);
            name = name.replace("Ñ", ":").replace("NN", "Ñ");

            speakName(name);

            //search order then access first child (searched order)
            firebase.database().ref('pendingOrders').orderByChild('id').equalTo(input).once("value", function(snapshot) {
                if(snapshot.val()) { 
                    snapshot.forEach(function(childSnapshot) {
                        if(!childSnapshot.val().porEntregar) {
                            addToPorEntregar(childSnapshot, "aCremas");
                            addToPorEntregar(childSnapshot, "aJamones");
                            addToPorEntregar(childSnapshot, "aBodega");
                            firebase.database().ref('pendingOrders/' + childSnapshot.key + '/porEntregar').set(true);
                        } else {
                            backFromPorEntregar(childSnapshot, "aCremas");
                            backFromPorEntregar(childSnapshot, "aJamones");
                            backFromPorEntregar(childSnapshot, "aBodega");
                            firebase.database().ref('pendingOrders/' + childSnapshot.key + '/porEntregar').set(false);
                        }
                    });
                }
            });
        }

        function addToPorEntregar(childSnapshot, area) {
            childSnapshot.child(area).forEach(function(specificOrderChild) {
                // check for served status
                firebase.database().ref(area + '/pendientes/' + specificOrderChild.key).once('value', function(servedChild) {
                    var jsonProduct = specificOrderChild.val(); 
                    jsonProduct.porSurtir = servedChild.exists();
                    // upload the product with served status
                    firebase.database().ref('pendingOrders/' + childSnapshot.key + '/' + area + '/' + specificOrderChild.key).set(jsonProduct);
                    firebase.database().ref(area + '/porEntregar/' + specificOrderChild.key).set(jsonProduct).then(function() {
                        // delete old product
                        if(servedChild.exists())
                            firebase.database().ref(area + '/pendientes/' + specificOrderChild.key).remove();
                        else
                            firebase.database().ref(area + '/hechas/' + specificOrderChild.key).remove();
                    });
                });                        
            });
        }

        function backFromPorEntregar(childSnapshot, area) {
            childSnapshot.child(area).forEach(function(specificOrderChild) {
                // check for served status
                if(specificOrderChild.val().porSurtir) {
                    // adds the product to porSurtir and then deletes the porEntregar or entregadas product
                    firebase.database().ref(area + '/pendientes/' + specificOrderChild.key).set(specificOrderChild.val()).then(function() {
                        firebase.database().ref(area + '/porEntregar/' + specificOrderChild.key).remove();
                        firebase.database().ref(area + '/entregadas/' + specificOrderChild.key).remove();
                    });
                } else {
                    // adds the product to surtidas and then deletes the porEntregar or entregadas product
                    firebase.database().ref(area + '/hechas/' + specificOrderChild.key).set(specificOrderChild.val()).then(function() {
                        firebase.database().ref(area + '/porEntregar/' + specificOrderChild.key).remove();
                        firebase.database().ref(area + '/entregadas/' + specificOrderChild.key).remove();
                    });
                }                
            });
        }
      
        function speakName(name) {
            var justName = name;
            var words = name.split(" ");
            if(!isNaN(words[words.length - 1]))
                justName = name.substring(0, name.lastIndexOf(" "));
            justName = addAccent(justName);
            var msg = new SpeechSynthesisUtterance();
            msg.lang = "es-US";
            msg.rate = parseFloat(.9);
            msg.pitch = parseFloat(1.1);
            msg.voice = window.speechSynthesis.getVoices()[15];
            msg.text = justName;
            window.speechSynthesis.speak(msg);
        }
        function reloadOnUpdate() {
            firebase.database().ref("updates/entregas").on('value', function(snapshot) {
                if(snapshot.val()){
                    firebase.database().ref("updates/entregas").set(false).then(function() {
                        location.reload();
                    });
                }
            });
        }

        function checkDayChange() {
            var now = new Date();
            //now.setHours(now.getHours() - 7);
            var millisTill7pm = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 19, 00, 0, 0) - now;

            var visualConsole = document.getElementById("console");
            visualConsole.innerHTML = now.toTimeString() + "<br>" + visualConsole.innerHTML;

            if (millisTill7pm < 0) {
                if(now.getDay() == 0)
                    surveyUpdate();
                firebase.database().ref('aCremas').remove();
                firebase.database().ref('aJamones').remove();
                firebase.database().ref('aBodega').remove();
                firebase.database().ref('pendingOrders').remove();
            }
        }
        
        function surveyUpdate() {
            firebase.database().ref("survey").once('value', function(snapshot) {
                firebase.database().ref("srecord").set(snapshot.val()).then(function() {
                    setTimeout(function() { 
                        resetSurvey();
                    }, 60 * 60 * 1000);
                });
            });
        }
        
        function resetSurvey() {
            firebase.database().ref('survey').remove();
            firebase.database().ref("productos").once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    var aes = toAES(childSnapshot.key);
                    firebase.database().ref('survey/' + aes).set(aes.substr(aes.length - 8));
                });
            });
        }

        function toAES(string) {
            return aesjs.utils.hex.fromBytes(aesEcb.encrypt(aesjs.utils.utf8.toBytes(to16Bytes(string))));
        }

        function to16Bytes(string) {
            return string + " ".repeat(16 - string.length);
        }

        function addAccent(name) {
            name = name.toUpperCase();
            var newName = "";
            var words = name.split(" ");
            words.forEach(function (value, i) {
                if(namesDictonary[value] != null) 
                    newName = newName + " " + namesDictonary[value];
                else 
                    newName = newName +  " " + value;
            });
            console.log(newName);
            return newName;
        }

        function populateDictonary(names) {
            names = removeDups(names);
            names = names.sort();

            namesArray.forEach(function (value, i) {
                namesDictonary[value.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toUpperCase()] = value.toUpperCase();
            });
        }

        function removeDups(names) {
            let unique = {};
            names.forEach(function(i) {
                if(!unique[i]) {
                    unique[i] = true;
                }
            });
            return Object.keys(unique);
        }

    </script>
</body>

</html>