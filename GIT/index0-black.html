<!DOCTYPE html>
<html lang="en">

<head>

    <title>Search view</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- local style resources -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/index_black.css">

    <!-- local js resources -->
    <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/bootstrap.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/firebase.js"></script>
    <script language="javascript" type="text/javascript" src="js/jspdf.customfonts.min.js "></script>
    <script language="javascript" type="text/javascript" src="js/default_vfs.js"></script>
    <script language="javascript" type="text/javascript" src="js/defiant.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/qrcode.js"></script>
    <script language="javascript" type="text/javascript" src="js/index.js"></script>
    <script language="javascript" type="text/javascript" src="js/aes.js"></script>
    <script language="javascript" type="text/javascript" src="js/facturama.api.js"></script>

    <script>
        var products,
            defiantClients;
        var orderRefID = "";
        firebase.initializeApp(connectFB());
        var database = firebase.database().ref('productos/');
        database.on('value', function (snapshot) {
            products = Defiant.getSnapshot(snapshot.val());
            //new field
            //for (const [key, value] of Object.entries(snapshot.val()))
            //    firebase.database().ref('productos/' + `${key}` + '/categoria').set(4);
        });

        var clientName = "",
            clientNumber = "";
        var databaseClients = firebase.database().ref('service/7isReady/');
        databaseClients.on('value', function (snapshot) {
            defiantClients = Defiant.getSnapshot(snapshot.val());
        });

        var globalComputer = "liveView0";
        var globalWaitingOrders,
            globalTPP = [];
        var aesEcb = new aesjs.ModeOfOperation.ecb(aesMethod);
        var productsCounter = 0;

        var qrid = "";

    </script>

</head>

<body style="background-color: #111111;">

    <!-- no connection alert -->
    <div class="alert alert-danger" style="display: none" id="noConnectionAlert" role="alert">
        <strong> No hay internet. </strong> 
            Revisa la conexión o el modem. Puedes seguir trabajando pero las cremas, jamones y otros productos no serán enviados a sus departamentos.
    </div>
    
    <!-- qr code container (invisible) -->
    <div id="qrcode" style="position: absolute; left: -9999px"></div>

    <!-- main container -->
    <div class="container-fluid">
        <div class="form-group row first-row" style="padding: 5px 5px">
            <!-- name input -->
            <div id="inputNameContainer" class="col-md-5" style="padding-left: 5px; padding-right: 0;">
                <input id="inputName" type="input" oninput="this.value = this.value.toUpperCase()" class="form-control" style="float:left; width: 88%; margin-top: 1px; background-color: #111111; color: #EEEEEE; border-color: #555555;" maxlength="20" placeholder="NOMBRE"> </input>
                <button type="button" class="btn btn-danger interface-button glyphicon glyphicon-plus-sign"
                    id="addClientButton" style="float:right; font-weight: bold; height: 34px;"
                    onclick="showAddClientModal()">
                </button>
                <ul class="list-group client-options" id="clientOptions"></ul>
                <span id="greenCheck" class="glyphicon glyphicon-ok"></span>
                <span id="greenCheckW" class="glyphicon glyphicon-ok"></span>
                <span id="greenCheckWN" class="glyphicon glyphicon-minus"></span>
            </div>
            <!-- tomorrow checkbox -->
            <div class="col-md-2" style="padding-top: 5px; padding-right: 5px;">
                <input type="checkbox" style="vertical-align: top; margin-top: 6.5px; margin-left: 32px; color: black;" class="form-check-input" id="tomorrowCheckbox">
                <label style="color: #BABABA; margin-bottom: 0px; opacity: .4; line-height: 23px; margin-top: 2.5px;" class="form-check-label" for="tomorrowCheckbox">&nbsp;M</label>
                <input type="checkbox" style="vertical-align: top; margin-top: 6.5px; margin-left: 15px;" class="form-check-input" id="invoiceCheckbox">
                <label style="color: #BABABA; margin-bottom: 0px; opacity: .4; line-height: 23px; margin-top: 2.5px;" class="form-check-label" for="invoiceCheckbox">&nbsp;F</label>
            </div>
            <!-- employee name input -->
            <select class="col-sm-1 form-control" style="margin-top: 1px; width: 162px; background-color: #111111; border-color: #555555; -webkit-appearance:none; padding-top:.5px;" id="inputEmployeeName">
                <option disabled selected>ANOTADOR</option>
            </select>
            <!-- interface buttons-->
            <button type="button" class="btn btn-danger interface-button glyphicon glyphicon-user" id="printButton" style="float: right; font-weight: bold; color: #EEEEEE;" onclick="generatePDF('MOSTRADOR')"></button>
            <button type="button" class="btn btn-danger interface-button glyphicon glyphicon-phone-alt" id="printByPhoneButton" style="float: right; margin-right: 5px; font-weight: bold; color: #EEEEEE;" onclick="generatePDF('TELEFONO')"></button>
            <button type="button" class="btn btn-danger interface-button" id="printByWhatsButton" style="float: right; margin-top: 1px; margin-right: 5px; font-weight: bold; -webkit-text-stroke: 1px; color: #EEEEEE;" onclick="generatePDF('WHATSAPP')"><i class="fa fa-whatsapp" style="font-size: 28px; line-height: 22.5px;" aria-hidden="true"></i></button>
            <button type="button" class="btn btn-secondary interface-button glyphicon glyphicon-plus-sign" style="float: right; margin-right: 5px; font-weight: bold;" onclick="addProductModal()"></button>
            <button type="button" class="btn btn-secondary interface-button glyphicon glyphicon glyphicon-bullhorn" style="float: right; margin-right: 5px; font-weight: bold;" onclick="callClient()"></button>
        </div>

        <div class="row" style="margin-bottom: 15px;">
            <!-- quantity box -->
            <div class="col-md-1" style="padding-right: 0px; padding-left: 10px;">
                <input type="number" min="0" id="quantityInput" class="form-control" style="background-color: #111111; color: #EEEEEE; border-color: #555555;"></input>
            </div>
            <!-- live search box -->
            <div class="col-md-11" style="padding-right: 5px;">
                <input type="d" class="form-control" id="inputSearch" oninput="this.value = this.value.toUpperCase()" placeholder="CLAVE O DESCRIPCION" style="background-color: #111111; color: #EEEEEE; border-color: #555555;"></input>
                <span id="wtTextField" style="color: #555555;"></span>
                <span id="npTextField" style="color: #555555;">PRODUCTOS: 0</span>
                <span id="totalTextField" style="color: #555555;">$0</span>
            </div>
        </div>

        <!-- search options list -->
        <ul class="list-group search-options" id="searchOptions"></ul>

        <!-- in order products list -->
        <ul class="list-group" id="dynamic-list" style="margin-left: -5px; margin-right: -10px; margin-bottom: 0px; padding-bottom: 0px; height: 620px; overflow: scroll;"> </ul>

        <!-- suggested products list -->
        <h3 class="modal-title" style="color: #BABABA; visibility: hidden;" id="sugerenciasLabel">SUGERENCIAS</h3>
        <ul class="list-group" id="dynamic-list-2" style="margin-left: -5px; padding-right: 4.2px; position: absolute; top: 522px; width: 99%; height: 250px; overflow: scroll; visibility: hidden;"> </ul>
    </div>

    <div id="calculator-div">
        <div id="calculator">
            <div class="result">
                <p></p>
            </div>
            <div class="clear btn-danger">C</div>
         
            <span class="calculator-button" style="margin-top: 22.5px; margin-left: 0;">7</span>
            <span class="calculator-button" style="margin-top: 22.5px;">8</span>
            <span class="calculator-button" style="margin-top: 22.5px;">9</span>
            <span class="calculator-button" style="margin-top: 22.5px; margin-right: 0px;">+</span>
         
            <span class="calculator-button" style="margin-left: 0px;">4</span>
            <span class="calculator-button">5</span>
            <span class="calculator-button">6</span>
            <span class="calculator-button" style="margin-right: 0px;">-</span>
         
            <span class="calculator-button" style="margin-left: 0px;">1</span>
            <span class="calculator-button">2</span>
            <span class="calculator-button">3</span>
            <span class="calculator-button" style="margin-right: 0px;">÷</span>
         
            <span class="calculator-button" style="margin-left: 0px;">0</span>
            <span class="calculator-button">.</span>
            <span class="calculator-button">=</span>
            <span class="calculator-button" style="margin-right: 0px;">x</span>
          </div>
    </div>

    <!-- edit / add new product modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" style="background-color: #111111;" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background-color: #222222;">

                <!-- modal title -->
                <div class="modal-header">
                    <h4 class="modal-title" style="color: #BABABA;" id="addProductModalLabel">AGREGAR PRODUCTO</h4>
                </div>
                <div class="modal-body" style="color: #BABABA;">
                    <form id="addNewProductDBForm">
                        <!-- form -->
                        <div class="form-group">

                            <!-- error message div -->
                            <label id="verificationMessage" style="color: red;"></label>
                            <div class="row" style="margin-bottom: 15px;">

                                <!-- description -->
                                <div class="col-sm-8">
                                    <label for="descriptionInput">DESCRIPCION</label>
                                    <input oninput="this.value = this.value.toUpperCase()" class="form-control" style="background-color: #222222; color: #BABABA; border-color: #555555;"
                                        type="text" maxlength="38" placeholder="DESCRIPCION" required>
                                </div>
                                <!-- id -->
                                <div class="col-sm-2">
                                    <label for="IDInput">CLAVE</label>
                                    <input id="inputID" oninput="this.value = this.value.toUpperCase()" style="background-color: #222222; color: #BABABA; border-color: #555555;"
                                        class="form-control" type="text" placeholder="CLAVE" required>
                                </div>
                                <!-- SAT id -->
                                <div class="col-sm-2">
                                    <label for="SATLabel">SAT</label>
                                    <input id="SATInput" oninput="this.value = this.value.toUpperCase()" style="background-color: #222222; color: #BABABA; border-color: #555555;"
                                        class="form-control" type="text" placeholder="CODIGO" required>
                                </div>
                            </div>

                            <div class="row">
                                <!-- cost -->
                                <div class="col-sm-3">
                                    <label for="priceInput">COSTO</label>
                                    <input class="form-control" type="number" min="0" placeholder="8.50" style="background-color: #222222; color: #BABABA; border-color: #555555;" required>
                                </div>
                                <!-- unit -->
                                <div class="col-sm-2">
                                   <div class="form-group">
                                       <label for="unitSelect">UNIDAD</label>
                                       <select class="form-control" id="unitSelect" style="background-color: #222222; color: #BABABA; border-color: #555555; -webkit-appearance:none;">
                                           <option value="PIEZA" selected>PIEZA</option>
                                           <option value="KILO">KILO</option>
                                           <option value="CAJA">CAJA</option>
                                           <option value="PROMO">PROMO</option>
                                           <option value="CUB">CUB</option>
                                       </select>
                                   </div>
                               </div>
                                <!-- stock -->
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="stockSelect">EXISTENCIA</label>
                                        <select class="form-control" id="stockSelect" style="background-color: #222222; color: #BABABA; border-color: #555555; -webkit-appearance:none;">
                                            <option value="siHay">SÍ HAY</option>
                                            <option value="noHay">NO HAY</option>
                                            <option value="pedido">RECOMENDADO</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- type -->
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="typeSelect">TIPO</label>
                                        <select class="form-control" id="typeSelect" style="background-color: #222222; color: #BABABA; border-color: #555555; -webkit-appearance:none;">
                                            <option value="porPesarCamara">CAMARA - SE NECESITA PESAR</option>
                                            <option value="yaPesadoCamara">CAMARA - YA VIENE PESADO</option>
                                            <option value="porPesarAfuera">AFUERA - SE NECESITA PESAR</option>
                                            <option value="yaPesadoAfuera">AFUERA - YA VIENE PESADO</option>
                                            <option value="yaPesadoAfueraTrino">AFUERA - YA VIENE PESADO - TRINO</option>
                                            <option value="aJamones">AREA DE JAMONES</option>
                                            <option value="aCremas">AREA DE CREMAS</option>
                                            <option value="aBodega">AREA DE BODEGA - ARRIBA</option>
                                            <option value="aBodegaAbajo">AREA DE BODEGA - ABAJO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- modal interface buttons (delete is hidden when "add new product" view is active) -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" style="color: #333333;">CANCELAR</button>
                    <button type="button" id="deleteButton" class="btn btn-danger" data-dismiss="modal" style="color: #333333;"
                        onclick="deleteProductDB();" style="display: none">ELIMINAR</button>
                    <button type="button" class="btn btn-danger" id="saveButton" data-type="newProduct" style="color: #333333;"
                        onclick="verifyNewProduct();">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addClientModal" tabindex="-1" role="dialog" style="background-color: #111111;" aria-labelledby="addClientModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background-color: #222222;">
                <div class="modal-header">
                    <h4 class="modal-title" id="addClientModalLabel" style="color: #BABABA;">NUEVO CLIENTE</h4>
                </div>
                <div class="modal-body" style="color: #BABABA; margin-bottom: 16px;">
                    <form id="addClientForm">
                        <div class="form-group">
                            <label id="addClientMessage" style="color: red;"></label>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col-sm-7">
                                    <label for="formNameInputLabel">NOMBRE</label>
                                    <input id="formNameInput" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        style="background-color: #222222; color: #BABABA; border-color: #555555;" type="text" placeholder="" maxlength="20" required>
                                </div>
                                <div class="col-sm-5">
                                    <div class="float-container" style="margin: 0px; padding: 0px;">
                                        <div class="float-child" style="float: left; margin: 0px; padding: 0px;">
                                            <label for="formNumberInputLabel" style="width: 195px;">WHATSAPP</label>
                                        </div>
                                        <div class="float-child" style="float: left; margin: 0px; padding: 0px;">
                                            <input type="checkbox" style="vertical-align: top; margin-top: 9px; margin-left: 0px; color: black;" class="form-check-input" id="noWhatsappCheckbox">
                                            <label style="width: 130px; color: #BABABA; margin-bottom: 0px; opacity: .4; line-height: 23px; margin-top: 5.5px;" class="form-check-label" for="noWhatsappCheckbox">&nbsp;NO QUIERE</label>
                                        </div>
                                    </div>
                                    <input id="formNumberInput" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        style="background-color: #222222; color: #BABABA; border-color: #555555;" type="number" minlength="12" maxlength="13" placeholder="" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" style="color: #333333;">CANCELAR</button>
                    <button type="button" id="deleteClientButton" class="btn btn-danger" data-dismiss="modal" onclick="deleteClientDB();" style="display: none; color: #333333;">ELIMINAR</button>
                    <button type="button" class="btn btn-danger" id="addClientButton" data-type="newClient"  onclick="verifyNewClient();" style="color: #333333;" form="addClientForm">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        populateEmployees();

        if(globalComputer == "liveView1" || globalComputer == "liveView0") {
            hearForCallClient();
        }

        //inputName on enter sequence
        $("#inputName").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#quantityInput").focus();
        });
        
        //addClient modal enter sequence
        $("#formNameInput").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#formNumberInput").focus();
        });
        $("#formNumberInput").on('keyup', function (e) {
            if (e.keyCode == 13)
                verifyNewClient();
        });

        $(document).on('click', function(e) {
            if (e.target.id != 'inputName' && e.target.id != 'clientOptions')
                $("#clientOptions").empty();
        });

        //update live view
        $("#inputName").focusout(function () {
            updateName($("#inputName").val());
            updateEmployee($("#inputEmployeeName").val());
        });
        $("#inputEmployeeName").on('change', function() {updateEmployee($("#inputEmployeeName").val())});

        //inputQuantity enter sequence
        $("#quantityInput").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#inputSearch").focus();
        });

        //FIX when edit product is clicked, its being added to the order, this fixes that.
        $("#addProductModal").on("hidden.bs.modal", function () {
            if ($('#saveButton').data("type") == "editProduct") {
                //FIX it is also being added to the liveView
                removeOrderProduct($('#dynamic-list li:first-child').data("date"));
                $('#dynamic-list li:first-child').remove();
            }
        });
        
        //inputName search onkeyup (live search action) SEARCH CLIENTS
        $("#inputName").on('keyup', function (e) {
            clientName = "";
            clientNumber = "";
            $("#greenCheck").css("visibility", "hidden");
            $("#greenCheckW").css("visibility", "hidden");
            $("#greenCheckWN").css("visibility", "hidden");
            firebase.database().ref(globalComputer + '/sorder').remove();
            $("#dynamic-list-2").html("");
            hideSugList();

            var searchResult;
            var inputSearchValue = $('#inputName').val();
            //search two or more words (imposible number)
            if (inputSearchValue.includes(" ")) {
                inputSearchValue = inputSearchValue.split(" ");
                for (i = 0; i < inputSearchValue.length; i++) {
                    if (inputSearchValue[i] != "") {
                        if (searchResult == null)
                            searchResult = JSON.search(defiantClients, '//*[contains(nombre, "' + inputSearchValue[i] + '")]' + '|//*[contains(numero, "' + inputSearchValue[i] + '")]');
                        else
                            searchResult = JSON.search(searchResult, '//*[contains(nombre, "' + inputSearchValue[i] + '")]' + '|//*[contains(numero, "' + inputSearchValue[i] + '")]');
                    }
                }
            }
            //search just one word (posible number)
            else {
                if ($('#inputName').val() != "")
                    searchResult = JSON.search(defiantClients, '//*[contains(nombre, "' + inputSearchValue + '")]' + '|//*[contains(numero, "' + inputSearchValue + '")]');
            }

            //loads the results into the list
            $("#clientOptions").empty();
            if ($('#inputName').val() != "") {
                //$("#dynamic-list").css("opacity", "0.25");
                populateLiveClientList(searchResult);

                //on enter the first search item is selected
                if (e.keyCode == 13 && searchResult.length > 0)
                    addClientObjectGetter(searchResult[0].Id);
            }// else
                //$("#dynamic-list").css("opacity", "1");
        });

        //inputSearch search onkeyup (live search action)
        $("#inputSearch").on('keyup', function (e) {
            //if still searching blur background
            if (e.keyCode == 219 || e.keyCode == 111) {
                $("#dynamic-list").css("opacity", "1");
                $("#dynamic-list-2").css("opacity", "1");
                $("#inputName").focus();
                $("#inputSearch").val($("#inputSearch").val().substring(0, $("#inputSearch").val().length - 1));
                setTimeout(function () {
                    $("#inputName").val($("#inputName").val().substring(0, $("#inputName").val().length - 1));
                }, 100);
                //unblur
            } else if (e.keyCode == 221 || e.keyCode == 106) {
                $("#dynamic-list").css("opacity", "1");
                $("#dynamic-list-2").css("opacity", "1");
                generatePDF("");
            }
            //search action
            else {
                var searchResult;
                var inputSearchValue = $('#inputSearch').val();
                //search two or more words (imposible id)
                if (inputSearchValue.includes(" ")) {
                    inputSearchValue = inputSearchValue.split(" ");
                    for (i = 0; i < inputSearchValue.length; i++) {
                        if (inputSearchValue[i] != "") {
                            if (searchResult == null)
                                searchResult = JSON.search(products, '//*[contains(descripcion, "' + inputSearchValue[i] + '")]' +
                                    '|//*[contains(unidad, "' + inputSearchValue[i] + '")]');
                            else
                                searchResult = JSON.search(searchResult, '//*[contains(descripcion, "' + inputSearchValue[i] + '")]' +
                                    '|//*[contains(unidad, "' + inputSearchValue[i] + '")]');
                        }
                    }
                }
                //search just one word (posible id)
                else {
                    if ($('#inputSearch').val() != "") {
                        searchResult = JSON.search(products, '//*[contains(clave, "' + $('#inputSearch').val() + '")]');
                        searchResultSecond = JSON.search(products, '//*[contains(descripcion, "' + $('#inputSearch').val() + '")]' +
                            '|//*[contains(unidad, "' + $('#inputSearch').val() + '")]');
                        Array.prototype.push.apply(searchResult, searchResultSecond);
                    }
                }

                //loads the results into the list
                $("#searchOptions").empty();
                if ($('#inputSearch').val() != "") {
                    $("#dynamic-list").css("opacity", "0.25");
                    $("#dynamic-list-2").css("opacity", "0.25");
                    populateLiveSearchList(searchResult);

                    //on enter the first search item is selected
                    if (e.keyCode == 13 && searchResult.length > 0)
                        addProduct(searchResult[0]);
                } else {
                    $("#dynamic-list").css("opacity", "1");
                    $("#dynamic-list-2").css("opacity", "1");
                }
            }
        });

        //calculator
        window.onload = function () {
            var buttons = document.getElementsByClassName('calculator-button'),
                result = document.querySelectorAll('.result p')[0],
                clear = document.getElementsByClassName('clear')[0];
            
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].innerHTML === '=') {
                    buttons[i].addEventListener("click", calculate(i));
                } else {
                    buttons[i].addEventListener("click", addValue(i));
                }
            }
            
            clear.onclick = function () {
                result.innerHTML = '';
            };  
            
            function addValue(i) {
                return function () {
                    if(i == 15)
                        result.innerHTML += "*";
                    else if(i == 11)
                        result.innerHTML += "/";
                    else
                        result.innerHTML += buttons[i].innerHTML;
                };
            }
            
            function calculate(i) {
                return function () {
                    var final_res = result.innerHTML;                                 
                    result.innerHTML = eval(final_res);
                };
            }
        };

        //populates client search list after the result has been processed
        function populateLiveClientList(searchResult) {
            var clientItem = "";
            //up to 51 results in search bar
            for (var i = 0; i < searchResult.length && i < 51; i++) {
                clientItem =
                    '<button class="list-group-item row btn-default client-options-item" onclick="addClientObjectGetter(&#39;' + searchResult[i].numero + '&#39;)">' +
                    '<div class="col-sm-7" style="padding-left: 12px; padding-right: 0px;">' + searchResult[i].nombre + '</div>';
                if(searchResult[i].noquiere)
                    clientItem = clientItem + 
                        '<div class="col-sm-4 hidden-number" style="padding-left: 0px; padding-right: 0px;">' + "NO QUIERE" + '</div>';
                else if(isFakeWhatsapp(searchResult[i].numero))
                    clientItem = clientItem + 
                        '<div class="col-sm-4 hidden-number" style="padding-left: 0px; padding-right: 0px; visibility: hidden;">' + searchResult[i].numero + '</div>';
                else
                    clientItem = clientItem + 
                        '<div class="col-sm-4" style="padding-left: 0px; padding-right: 0px;">' + searchResult[i].numero + '</div>';

                clientItem = clientItem + 
                    '<div type="button" class="btn btn-sm col-sm-1" style="padding-left:1px;" onclick="editClientModal(&#39;' + searchResult[i].numero + '&#39;)"> ' + 
                        '<span style="color:grey; font-size:20px; line-height:96%;">&#9998;</span>' +
                    '</div>' +
                    '</button>';

                $("#clientOptions").append(clientItem);
            }
        }

        //edit or delete product modal values
        function editClientModal(numero) {
            document.getElementById("addClientModalLabel").innerHTML = "EDITAR CLIENTE";
            document.getElementById("verificationMessage").innerHTML = "";
            document.getElementById("addClientForm").reset();
            document.getElementById("deleteClientButton").style.display = "inline";

            var clientToEdit = JSON.search(defiantClients, '//*[contains(numero, "' + numero + '")]')[0];
            var form = document.getElementById("addClientForm");

            form.elements[0].value = clientToEdit.nombre;
            $('#noWhatsappCheckbox').prop('checked', clientToEdit.noquiere);
            form.elements[2].value = clientToEdit.numero;

            if(clientToEdit.noquiere)
                form.elements[2].disabled = true;

            $("#noWhatsappCheckbox").change(function() {
                var ischecked = $(this).is(':checked');
                if(ischecked) $('#formNumberInput').attr("disabled", true);
                else $('#formNumberInput').attr("disabled", false);
            });

            for(var i = 0; i < form.elements.length; i++) {
                if(form.elements[i].value == undefined || form.elements[i].value == "undefined")
                    form.elements[i].value = "";
            } 

            $('#addClientButton').data("type", "editClient");
            $('#addClientButton').data("numero", numero);
            $('#addClientButton').data("nombre", clientToEdit.nombre);

            $('#addClientModal').modal('show');
        }

        function addClientObjectGetter(numero) {
            searchResult = JSON.search(defiantClients, '//*[contains(numero, "' + numero + '")]');
            setClient(searchResult[0]);
        }

        function setClient(client) {
            $("#clientOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#inputName").val(client.nombre);
            clientName = client.nombre;
            clientNumber = client.numero;
            $("#greenCheck").css("visibility", "visible");
            if(client.numero.charAt(0) != "0")
                $("#greenCheckW").css("visibility", "visible");
            else if(client.noquiere) 
                $("#greenCheckWN").css("visibility", "visible");

            $("#dynamic-list-2").html("");
            hideSugList();
            populateSuggestedOrder(client.numero);
            populateSuggestedOrderLV(client.numero);
            updateName($("#inputName").val());
        }

        function isNaturalNumber(str) {
            var pattern = /^(0|([0-9]\d*))$/;
            return pattern.test(str);
        }

        function isValidName(name) {
            var pattern = /^[A-Z0-9 _]*[A-Z0-9][A-Z0-9 _]*$/;
            return pattern.test(name);
        }

        function getRandomW() {
            var randomint = Math.floor(Math.random() * 1000000000);
            randomint = ('000000000' + randomint).slice(-10);
            return randomint;
        }

        function generateNewRandomWhatsapp(localName, localNoquiere, form, messageLabel) {
            var newWhatsapp = getRandomW();
            databaseClients.child(newWhatsapp).once('value', function (snapshot) {
                if (snapshot.val() != null)
                    generateNewRandomWhatsapp(localName, localNoquiere, form, messageLabel);
                else
                    endClientDialog(localName, newWhatsapp, localNoquiere, form, messageLabel);
            });
        }

        function isFakeWhatsapp(whatsapp) {
            return whatsapp.length == 10 && whatsapp.charAt(0) == "0";
        }
        
        function verifyNewClient() {
            var messageLabel = document.getElementById("addClientMessage");
            var form = document.getElementById("addClientForm");
            var localName = form.elements[0].value,
                localNumber = form.elements[2].value;
                localNoquiere = $("#noWhatsappCheckbox").is(':checked');

            messageLabel.innerHTML = "";
            var verified = true;

            if (localName == "") {
                messageLabel.innerHTML = "INGRESA UN NOMBRE.";
                verified = false;
            }
            
            //when in add client view, the name needs to be always a new one
            var searchResult = JSON.search(defiantClients, '//*[nombre="' + localName + '"]');
            if ($('#addClientButton').data("type") == "newClient") {
                if (searchResult.length != 0) {
                    if(localName == searchResult[0].nombre) {
                        messageLabel.innerHTML = "EL NOMBRE YA EXISTE, INTENTA AGREGARLE UN APELLIDO.";
                        verified = false;
                    }
                }
            }
            //when in edit client, the name can be either the same or a new one, but not an existing one
            else if ($('#addClientButton').data("type") == "editClient") {
                if ($('#addClientButton').data("nombre") != localName && searchResult.length != 0) {
                    if(localName == searchResult[0].nombre) {
                        messageLabel.innerHTML = "EL NOMBRE YA EXISTE, INTENTA AGREGARLE UN APELLIDO.";
                        verified = false;
                    }
                }
            }
            
            //checks for points in number
            if ((localNumber != "") && !isNaturalNumber(localNumber)) {                
                messageLabel.innerHTML = "EL WHATSAPP SOLO PUEDE TENER NUMEROS.";
                verified = false;
            }
            
            //checks for 10 digit format in number
            if ((localNumber != "") && (isNaN(localNumber) || localNumber.length != 10)) {
                messageLabel.innerHTML = "EL WHATSAPP DEBE DE SER DE 10 DIGITOS.";
                verified = false;
            }
            
            //checks for any special character
            if (!isValidName(localName)) {
                messageLabel.innerHTML = "EL NOMBRE SOLO PUEDE TENER LETRAS Y/O NUMEROS.";
                verified = false;
            }

            //checks for at least a letter
            if (!localName.match(/[A-Z]/i)) {
                messageLabel.innerHTML = "EL NOMBRE NO PUEDE SER UN NUMERO.";
                verified = false;
            }

            //checks for existing numbers
            if (localNumber != "") {
                databaseClients.child(localNumber).once('value', function (snapshot) {
                    //when in "add client" view, the id needs to be always a new one
                    if ($('#addClientButton').data("type") == "newClient") {
                        if (snapshot.val() !== null) {
                            messageLabel.innerHTML = "EL WHATSAPP YA EXISTE, VERIFICALO.";
                            verified = false;
                        }
                    }
                    //when in edit client, the number can be either the same or a new one, but not an existing one
                    else if ($('#addClientButton').data("type") == "editClient") {
                        if ($('#addClientButton').data("numero") != localNumber) {
                            if (snapshot.val() !== null) {
                                messageLabel.innerHTML = "EL WHATSAPP YA EXISTE, VERIFICALO.";
                                verified = false;
                            }
                        }
                    }
                });
            }

            if(verified) {
                if(localNumber == "") {
                    generateNewRandomWhatsapp(localName, localNoquiere, form, messageLabel);
                } else
                    endClientDialog(localName, localNumber, localNoquiere, form, messageLabel);
            }
            return false;
        }

        function endClientDialog(localName, localNumber, localNoquiere, form, messageLabel) {
            saveClientDB(localName, localNumber, localNoquiere);
            messageLabel.innerHTML = "";

            //if at edit product the id changes, deletes the old ids instance
            if ($('#addClientButton').data("type") == "editClient")
                if ($('#addClientButton').data("numero") != localNumber)
                    databaseClients.child($('#addClientButton').data("numero")).remove();

            emptyForm(form, form.elements.length);
            $("#clientOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#dynamic-list-2").css("opacity", "1");

            setTimeout(function () {
                $("#quantityInput").focus();
            }, 500);
        }

        function saveClientDB(name, number, localNoquiere) {
            firebase.database().ref('service/7isReady/' + number).set({
                nombre: name,
                numero: number,
                noquiere: localNoquiere
            }).then(function () {
                $("#inputName").val(name);
                clientName = name;
                clientNumber = number;
                $("#greenCheck").css("visibility", "visible");
                if(number.charAt(0) != "0")
                    $("#greenCheckW").css("visibility", "visible");
                else if(client.noquiere) 
                    $("#greenCheckWN").css("visibility", "visible");
                $('#addClientModal').modal('toggle');
                updateName($("#inputName").val());
            });
        }

        function deleteClientDB() {
            databaseClients.child($('#addClientButton').data("numero")).remove().then(function () {
                $("#inputName").val("");
                $("#clientOptions").empty();
                $("#dynamic-list").css("opacity", "1");
                clientName = "";
                clientNumber = "";
                $("#greenCheck").css("visibility", "hidden");
                $("#greenCheckW").css("visibility", "hidden");
                $("#greenCheckWN").css("visibility", "hidden");
                firebase.database().ref(globalComputer + '/sorder').remove();
                $("#dynamic-list-2").html("");
                hideSugList();
            });
        }

        function callClient() {
            var localComputer = globalComputer.slice(globalComputer.length - 1, globalComputer.length);
            firebase.database().ref('service/' + localComputer + 'isReady').set(false).then(function() {
                firebase.database().ref('service/' + localComputer + 'isReady').set(true);
            });
        }

        function hearForCallClient() {
            firebase.database().ref('service/0isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/0isReady').set(false);
                    speak(0);
                }
            });
            firebase.database().ref('service/1isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/1isReady').set(false);
                    speak(1);
                }
            });
            firebase.database().ref('service/2isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/2isReady').set(false);
                    speak(2);
                }
            });
            firebase.database().ref('service/3isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/3isReady').set(false);
                    speak(3);
                }
            });
            firebase.database().ref('service/4isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/4isReady').set(false);
                    speak(4);
                }
            });
            firebase.database().ref('service/5isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/5isReady').set(false);
                    speak(5);
                }
            });
            firebase.database().ref('service/6isReady').on('value', function (snapshot) {
                if(snapshot.val()) {
                    firebase.database().ref('service/6isReady').set(false);
                    speak(6);
                }
            });
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function speak(computer) {
			var msg = new SpeechSynthesisUtterance();
			msg.rate = 1;

            var hours = (new Date()).getHours();
            var ampm = hours >= 12 ? 'pm' : 'am';

            var greeting = "buenos días";
            if(ampm = "pm")
                greeting = "buenas tardes";
            
            var randomInt = getRandomInt(4);
            if(randomInt == 1)
			    msg.text = "buena tarde, " + greeting + ", pase el siguiente a la " + computer;
            else
                msg.text = "buena tarde, pase el siguiente a la " + computer;

            //msg.voice = speechSynthesis.getVoices()[speechSynthesis.getVoices().findIndex(item => item.name === 'Google español de Estados Unidos')];
            msg.voice = speechSynthesis.getVoices()[1];
			window.speechSynthesis.speak(msg);

		}

        function showAddClientModal() {
            document.getElementById("addClientModalLabel").innerHTML = "NUEVO CLIENTE";
            document.getElementById("addClientMessage").innerHTML = "";
            document.getElementById("deleteClientButton").style.display = "none";
            document.getElementById("addClientForm").reset();
            $('#addClientButton').data("type", "newClient");

            $("#noWhatsappCheckbox").change(function() {
                var ischecked = $(this).is(':checked');
                if(ischecked) $('#formNumberInput').attr("disabled", true);
                else $('#formNumberInput').attr("disabled", false);
            });

            $("#formNameInput").val($("#inputName").val());
            $('#addClientModal').modal('show');
            setTimeout(function () {
                if($("#formNameInput").val() == "")
                    $("#formNameInput").focus();
                else
                    $("#formNumberInput").focus();
            }, 500);
        }

        function populateEmployees() {
            var empleadosDB;
			firebase.database().ref("empleados").once('value', function(snapshot) {
				empleadosDB = snapshot.val();
			}).then(function(){
				$.each(empleadosDB, function(key, value) {
                    var sel = document.getElementById('inputEmployeeName');
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode(key.toUpperCase()));
                    opt.value = key.toUpperCase(); 
                    sel.appendChild(opt);
				});
			});
        }

        //populates live search list after the result has been processed
        function populateLiveSearchList(searchResult) {
            var backgroundColor,
                color,
                buttonColor;
            var searchItem = "";
            //up to 51 results in search bar
            for (var i = 0; i < searchResult.length && i < 51; i++) {
                if(searchResult[i].existencia == "siHay") {
                    backgroundColor = "#111111";
                    color = "#EEEEEE";
                    buttonColor = "gray";
                } else if(searchResult[i].existencia == "noHay") {
                    buttonColor = "#rgba(216, 61, 52, 95%)";
                    color = "rgba(216, 61, 52, 95%)";
                    backgroundColor = "#111111";
                } else if(searchResult[i].existencia == "pedido") {
                    buttonColor = "rgba(51, 204, 51, 80%)";
                    color = "rgba(51, 204, 51, 80%)";
                    backgroundColor = "#111111";
                }

                //background-color: #111111; color: #EEEEEE; border-color: #555555;
                searchItem =
                    '<button class="list-group-item row btn-default search-options-item" style="background-color: ' + backgroundColor + '; color: ' + color + '; border-color: #555555;" onclick="addProductObjectGetter(&#39;' + searchResult[i].clave + '&#39;)">' +
                    '<div class="col-sm-2">' + searchResult[i].clave + '</div>' +
                    '<div class="col-sm-1">' + searchResult[i].unidad + '</div>' +
                    '<div class="col-sm-7">' + searchResult[i].descripcion + '</div>' +
                    '<div class="col-sm-1">' + searchResult[i].costo + '</div>' +
                    '<div type="button" class="btn btn-sm col-sm-1 edit-button" onclick="editProductModal(&#39;' + searchResult[i].clave + '&#39;)">' +
                    '<span id="editar-button" style="color:' + buttonColor + ';"> EDITAR </span>' +
                    '</div>' +
                    '</button>';
                $("#searchOptions").append(searchItem);
            }
        }

        //edit or delete product modal values
        function editProductModal(id) {
            document.getElementById("addProductModalLabel").innerHTML = "EDITAR PRODUCTO";
            document.getElementById("inputID").disabled = true;
            document.getElementById("deleteButton").style.display = "inline";
            document.getElementById("verificationMessage").innerHTML = "";

            var productToEdit = JSON.search(products, '//*[clave="' + id + '"]')[0];
            var form = document.getElementById("addNewProductDBForm");
            //{description:0, id:1, SAT:2, cost:3, unit:4, stock:5, type:6}
            form.elements[0].value = productToEdit.descripcion;
            form.elements[1].value = productToEdit.clave;
            form.elements[2].value = productToEdit.xpcode;
            form.elements[3].value = productToEdit.costo;
            $("#unitSelect").val(productToEdit.unidad);
            $("#stockSelect").val(productToEdit.existencia);
            $("#typeSelect").val(productToEdit.tipo);

            //sets buttons inner values
            $('#saveButton').data("type", "editProduct");
            $('#saveButton').data("id", form.elements[1].value);

            $('#addProductModal').modal('show');
        }

        //sets modal to add product view
        function addProductModal() {
            document.getElementById("addProductModalLabel").innerHTML = "AGREGAR PRODUCTO";
            document.getElementById("inputID").disabled = false;
            document.getElementById("deleteButton").style.display = "none";
            document.getElementById("verificationMessage").innerHTML = "";
            emptyForm(document.getElementById("addNewProductDBForm"), 7);

            $('#saveButton').data("type", "newProduct");
            $('#addProductModal').modal('show');
        }

        //deletes an existing product from the db
        function deleteProductDB() {
            $('#dynamic-list li:first-child').remove();
            var id = document.getElementById("addNewProductDBForm").elements[1].value;
            database.child(id).remove();
        }

        //verifies input of modal form
        function verifyNewProduct() {
            var messageLabel = document.getElementById("verificationMessage");
            var form = document.getElementById("addNewProductDBForm");
            var verified = true;

            //checks for blanks
            var inputs = new Array(7);
            //{description:0, id:1, SAT:2, cost:3, unit:4, stock:5, type:6}
            for (var i = 0; i < inputs.length; i++) {
                inputs[i] = form.elements[i].value;
                if (inputs[i] == "") {
                    messageLabel.innerHTML = "LLENA TODOS LOS CAMPOS.";
                    verified = false;
                    break;
                }
            }

            //checks for spaces in id
            if (form.elements[1].value.indexOf(" ") >= 0) {
                messageLabel.innerHTML = "LA CLAVE NO PUEDE TENER ESPACIOS.";
                verified = false;
            }

            //checks for 8 digit format in SAT
            if (isNaN(form.elements[2].value) || form.elements[2].value.length != 8) {
                messageLabel.innerHTML = "EL CODIGO DEL SAT DEBE DE SER DE 8 DIGITOS.";
                verified = false;
            }

            //checks for $ or -
            if (form.elements[1].value.indexOf("$") >= 0 || form.elements[1].value.indexOf("-") >= 0) {
                messageLabel.innerHTML = "LA CLAVE SOLO PUEDE TENER LETRAS Y/O NUMEROS";
                verified = false;
            }

            //checks for existing ids
            if (form.elements[1].value != "") {
                database.child(form.elements[1].value).once('value', function (snapshot) {
                    //when in "add product" view, the id needs to be always a new one
                    if ($('#saveButton').data("type") == "newProduct") {
                        if (snapshot.val() !== null) {
                            messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
                            verified = false;
                        }
                    }
                    //OUTDATED when in edit product, the id can be either the same or a new one, but not an existing one
                    else if ($('#saveButton').data("type") == "editProduct") {
                        if ($('#saveButton').data("id") != form.elements[1].value) {
                            if (snapshot.val() !== null) {
                                messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
                                verified = false;
                            }
                        }
                    }
                });
            }

            //checks for stock status
            if ($('#unitSelect').val() == "undefined") {
                messageLabel.innerHTML = "FALTA DEFINIR UNIDAD.";
                verified = false;
            }

            //checks for stock status
            if ($('#stockSelect').val() == "undefined") {
                messageLabel.innerHTML = "FALTA DEFINIR EXISTENCIA.";
                verified = false;
            }

            //if everything is checked, upload form
            if (verified) {
                addNewProductDB(inputs);
                messageLabel.innerHTML = "";

                //OUTDATED if at edit product the id changes, deletes the old ids instance
                if ($('#saveButton').data("type") == "editProduct")
                    if ($('#saveButton').data("id") != form.elements[1].value)
                        database.child($('#saveButton').data("id")).remove();

                emptyForm(form, inputs.length);
            }
        }

        //clears modal form values
        function emptyForm(form, length) {
            form.reset();
        }

        //adds or updates a product to firebase
        function addNewProductDB(inputs) {
            firebase.database().ref('productos/' + inputs[1]).set({
                clave: inputs[1],
                costo: inputs[3],
                descripcion: inputs[0],
                existencia: inputs[5],
                tipo: inputs[6],
                unidad: inputs[4],
                xpcode: inputs[2],
                categoria: 1
            }).then(function () {
                $('#addProductModal').modal('toggle');
            });
        }

        //FUTURE FIX adds a product to the order by id (only gets the product from the DB so that it can be added in addProduct())
        function addProductObjectGetter(ID) {
            var searchResult = JSON.search(products, '//*[clave="' + ID + '"]');
            addProduct(searchResult[0]);
        }

        function hideSugList() {
            $('#dynamic-list').css("height", "620px");
            $('#dynamic-list').css("margin-bottom", "0px");
            $('#dynamic-list-2').css("visibility", "hidden");
            $('#sugerenciasLabel').css("visibility", "hidden");
        }
        
        function showSugList() {
            $('#dynamic-list').css("height", "360px");
            $('#dynamic-list').css("margin-bottom", "8px");
            $('#dynamic-list-2').css("visibility", "visible");
            $('#sugerenciasLabel').css("visibility", "visible");
        }

        //adds the item to the list
        function addProduct(product) {
            $("#searchOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#dynamic-list-2").css("opacity", "1");
            $("#inputSearch").val("");

            var date = (new Date()).getTime();
            var color,
                backgroundColor;
            if(product.existencia == "siHay") {
                color = "#EEEEEE";
                backgroundColor = "#111111";
            }
            else if(product.existencia == "noHay") {
                color = "rgba(216, 61, 52, 95%)";
                backgroundColor = "#111111";
            }
            else if(product.existencia == "pedido") {
                color = "rgba(51, 204, 51, 80%)";
                backgroundColor = "#111111";
            }

            var totalCost = "";
            if($("#quantityInput").val() != "") {
                totalCost = $("#quantityInput").val() * product.costo;
                totalCost = "$" + Math.round(totalCost * 10) / 10
            }
                
            var productListItem =
                '<li class="list-group-item row product-row product-total" style= "background-color: ' + backgroundColor + '; color: ' + color + '; border-color: #555555;" data-id="' + product.clave + '" data-date="' + date + '" data-total="' + round($("#quantityInput").val() * product.costo) + '">' +
                    '<div class="col-sm-1 product-quantity">' +
                        '<input type="number" min="0" class="form-control" style= "color: ' + color + '; background-color: ' + backgroundColor + '; border-color: #555555; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;"></input>' +
                    '</div>' +
                    '<div class="col-sm-1 product-info">' + product.unidad + '</div>' +
                    '<div class="col-sm-6 product-info">' + product.descripcion + '</div>' +
                    '<div class="col-sm-1 product-info" id="localCost">' + totalCost + '</div>' +
                    '<div class="col-sm-2 product-notes-container">' +
                        '<input type="input" oninput="this.value = this.value.toUpperCase()" style= "color: ' + color + '; background-color: ' + backgroundColor + '; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;" class="form-control product-notes" maxlength="48" placeholder="NOTAS"> </input>' +
                    '</div>' +
                    '<button type="button" class="btn btn-default btn-sm col-sm-1 remove-button cross" style="background-color: ' + backgroundColor + '; border-color: ' + backgroundColor + ';">' +
                        '<span class="glyphicon glyphicon-remove cross" style="color:grey; padding-top: 4.5px;"></span>' +
                    '</button>' +
                '</li>';

            //add list element
            $('#dynamic-list').prepend(productListItem);
            updateTotal();

            deleteSuggestedProduct(product.clave);
            
            //populate quantity and clean original (outter) input
            var outterQuantity = $("#quantityInput").val();
            var inputQuantity = $('#dynamic-list').find('input').first();
            inputQuantity.val(outterQuantity);
            $("#quantityInput").val("");
            
            updateWT();

            productsCounter++;
            updateNP(productsCounter);

            //inputSearch sequence
            $('#dynamic-list').find('input').eq(1).focus();

            $('#dynamic-list').find('input').first().on('change', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * product.costo)));
                thisRow.children().eq(3).text("$" + round($(this).val() * product.costo));
                updateTotal();
                updateWT();
            })

            //inputQuantity enter sequence (to notes)
            $('#dynamic-list').find('input').first().on('keyup', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * product.costo)));
                thisRow.children().eq(3).text("$" + round($(this).val() * product.costo));
                updateTotal();
                updateWT();
                if (e.keyCode == 13)
                    $(this).parent().nextAll().eq(3).children().focus();
            });

            //inputNotes enter sequence with shortcuts (to outter quantity)
            var inputNotes = $('#dynamic-list').find('input').eq(1);
            inputNotes.on('keyup', function (e) {
                if (e.keyCode == 13) {
                    if (inputNotes.val() == "S")
                        inputNotes.val("SURTIDO");
                    else if (inputNotes.val() == "K")
                        inputNotes.val("EN KILOS");
                    else if (inputNotes.val() == "M")
                        inputNotes.val("EN MEDIOS");
                    else if (inputNotes.val() == "C")
                        inputNotes.val("EN CUARTOS");
                    else if (inputNotes.val() == "2")
                        inputNotes.val("2-2");
                    else if (inputNotes.val() == "3")
                        inputNotes.val("3-3");
                    else if (inputNotes.val() == "4")
                        inputNotes.val("4-4");
                    else if (inputNotes.val() == "5")
                        inputNotes.val("5-5");
                    else if (inputNotes.val() == "J")
                        inputNotes.val("JUNTA");
                    $("#quantityInput").focus();
                }
            });

            //upload or update order item
            uploadOrderProduct(date, outterQuantity, product.unidad, product.descripcion, "", product.costo, product.existencia, product.tipo, product.clave);
            inputQuantity.focusout(function () {updateOrderProductQuantity(date, inputQuantity.val())});
            inputNotes.focusout(function () {updateOrderProductNotes(date, inputNotes.val())});

            $('#dynamic-list').children().first().on("mouseup", "button", function (e) {
                e.preventDefault();
                
                removeOrderProduct($(this).parent().data("date"));
                $(this).parent().remove();
                
                updateTotal();
                updateWT();
                productsCounter--;
                updateNP(productsCounter);
            });

            /* OUTDATED
            //deleteButton action
            $("#dynamic-list").on("click", "button", function (e) {
                e.preventDefault();
                removeOrderProduct($(this).parent().data("date"));
                
                $("#dynamic-list").find("[data-date='" + $(this).parent().data("date") + "']").remove();
                updateTotal();
                //updateWT();
            });
            */
        }

        //populates an array with all the order product values
        function getOrderProducts() {
            verifiedOrder = true;
            var typesSequence = ["porPesarCamara", "yaPesadoCamara", "porPesarAfuera", "yaPesadoAfuera", "yaPesadoAfueraTrino", "aCremas", "aJamones", "aBodega", "aBodegaAbajo"];
            
            var newOrder = [];

            //iterates over order types to divide them
            for (var sequenceIndex = 0; sequenceIndex < typesSequence.length; sequenceIndex++) {
                var orderTypeSection = [];
                //iterates over order list items
                $("#dynamic-list").children().each(function (index) {
                    if (JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].tipo == typesSequence[sequenceIndex]) {
                        var productItem = $(this).children();

                        var orderTypeUnit = [];
                        orderTypeUnit.push($(this).data("id"));
                        orderTypeUnit.push(productItem.eq(0).children().val());
                        orderTypeUnit.push(productItem.eq(1).text());
                        orderTypeUnit.push(productItem.eq(2).text());
                        orderTypeUnit.push(productItem.eq(4).children().val());
                        orderTypeUnit.push(JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].tipo);
                        orderTypeUnit.push(JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].xpcode);
                        orderTypeUnit.push(JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].costo);

                        orderTypeSection.push(orderTypeUnit);

                        orderTypeUnit.push(JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].categoria);

                        //verificating quantity
                        if (orderTypeUnit[1] == "" || orderTypeUnit[1] == "0") {
                            alert("Un producto no tiene cantidad, ingresa todas las cantidades.");
                            verifiedOrder = false;
                        }
                    }
                });
                
                orderTypeSection.sort(compareOrders);
                if(orderTypeSection.length > 0)
                    for(var i in orderTypeSection)
                        newOrder.push(orderTypeSection[i]);
                
            }

            return newOrder;
        }

        function compareOrders(a, b) {
            if (a[3] < b[3])
                return -1;
            if (a[3] > b[3])
                return 1;
            return 0;
        }

        function updateTotal() {
            var total = 0;
            $(".product-total").each(function(index) {
                total = total + ($(this).data("total") * 1);
            });
            $("#totalTextField").text("$" + round(total));
        }
        
        function updateWT() {
            var nproducts = 0;
            $("#dynamic-list").children().each(function (index) {
                var type = JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].tipo;
                var quantity = $(this).children().eq(0).children().val();
                if (type == "porPesarCamara" || type == "yaPesadoCamara" || type == "porPesarAfuera" || type == "yaPesadoAfuera")
                    if(quantity != "")
                        nproducts = nproducts + parseFloat(quantity);
            });

            if(nproducts == 0) 
                $("#wtTextField").text("TIEMPO ESTIMADO: 0M");
            else
                $("#wtTextField").text("TIEMPO ESTIMADO: " + calculateWTime(Math.ceil(nproducts)) + "M");
        }

        function updateNP(np) {
            $("#npTextField").text("PRODUCTOS: " + np);
        }

        function uploadSugReasons(clientName, clientNumber) {
            $("#dynamic-list-2").children().each(function(index) {
                var sugReason = $(this).children().eq(4).children().eq(0).val();
                if(sugReason != "") {
                    var thismoment = Date.now();
                    var sugQuantity = $(this).children().eq(0).text();  
                    firebase.database().ref('sugerencias/' + $(this).data("id") + '/' + thismoment).set({
                        name: clientName,
                        number: clientNumber,
                        reason: sugReason,
                        quantity: sugQuantity
                    });
                }
            });            
        }

        //FIX
        //if(globalComputer == "liveView1" || globalComputer == "liveView2" || globalComputer == "liveView3") {
            var xOffset = 40;
            var yOffset = -2;
        //} else {
        //    var xOffset = 37;
        //    var yOffset = -4;
        //}
        
        //FUTURE FIX (HUGE FUNCTION) - generates a PDF with autoprint
        function generatePDF(orderMethod) {
            //set PDF defaults
            var order = getOrderProducts();
            if ($("#inputName").val() == "") {
                alert("FALTA EL NOMBRE DEL CLIENTE");
                verifiedOrder = false;
            } else if (!$("#inputName").val().match(/[A-Z]/i)) {
                alert("El NOMBRE DEL CLIENTE NO PUEDE SER UN NUMERO");
                verifiedOrder = false;
            } else if ($("#inputEmployeeName").val() == null) {
                alert("FALTA EL NOMBRE DEL ANOTADOR");
                verifiedOrder = false;
            }

            if (verifiedOrder) {
                var doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: [297, 210]
                });

                //add custom fonts
                doc.addFont('GILC____.TTF', "Gill Sans Std Condensed", "normal");
                doc.addFont('GillSansMTCondensedBold.ttf', "Gill Sans MT Condensed Negrita", "normal");
                doc.setFont("Gill Sans MT Condensed Negrita");

                var iftomorrow = $("#tomorrowCheckbox").is(':checked');
                var ordertype = orderMethod;
                
                //add defaults values
                addTimePDF(doc);
                addMethodPDF(doc, orderMethod);
                addNamePDF(doc, order.length);

                //creates the database instance
                createNameDB($("#inputName").val());

                //creates pending products key (aJamones, aCremas, aBodega)
                var withPendingProducts = false;
                var productsRefID = "";
                var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                var randomLetter1 = possible.charAt(Math.floor(Math.random() * possible.length));
                var randomLetter2 = possible.charAt(Math.floor(Math.random() * possible.length));

                //add copy
                addPagePDF(doc, orderMethod, order.length);
                doc.setPage(1);

                var shortenedUnits = {
                    KILO: "KG",
                    PIEZA: "PZ",
                    CAJA: "CJ",
                    CUB: "CB",
                    EXB: "EX",
                    PROMO: "PR"
                };

                var sOrderProducts = {};

                var calculable = true;
                var total = 0;
                var category = 0;
                var categories = [.05, .10, .15, .20, .25];

                var firstLineYPosition = 49.8 + yOffset;
                var lineHeight = 8.54;
                var currentLine = 0;
                var pagesQuantity = 1;
                var surveyValues = order;
                var nproducts = 0;
                var ndiversity = 0;
                var haspanela = false;
                var hasChuletaN = false;
                var onlyafuera = true;
                var hasBidon = false;
                for (var i = 0; i < order.length; i++) {
                    //adds new page if necessary
                    //if (currentLine == 18 || (currentLine == 17 && order[i][4] != "")) {
                    if (currentLine == 17) {
                        pagesQuantity++;
                        addPagePDF(doc, orderMethod, order.length);
                        addPagePDF(doc, orderMethod, order.length);
                        doc.setPage(pagesQuantity * 2 - 1);
                        currentLine = 0;
                    }

                    sOrderProducts[order[i][0]] = {
                        uc: Number(order[i][1]),
                        n: order[i][4]
                    };

                    //quantity and unit
                    doc.setFont("Gill Sans MT Condensed Negrita");
                    doc.setFontSize(12.5);
                    var quantityAndUnit = order[i][1] + shortenedUnits[order[i][2]];

                    //enhance quantity if necessary
                    if (quantityAndUnit.includes(".500"))
                        quantityAndUnit = quantityAndUnit.replace(".500", ".500");
                    else if (quantityAndUnit.includes(".50"))
                        quantityAndUnit = quantityAndUnit.replace(".50", ".500");
                    else if (quantityAndUnit.includes(".5"))
                        quantityAndUnit = quantityAndUnit.replace(".5", ".500");
                    else if (quantityAndUnit.includes(".250"))
                        quantityAndUnit = quantityAndUnit.replace(".250", ".250");
                    else if (quantityAndUnit.includes(".25"))
                        quantityAndUnit = quantityAndUnit.replace(".25", ".250");

                    if (quantityAndUnit.slice(0, 4) == ".500")
                        quantityAndUnit = quantityAndUnit.replace(".500", "1/2");
                    else if (quantityAndUnit.slice(0, 4) == ".250")
                        quantityAndUnit = quantityAndUnit.replace(".250", "1/4");

                    if(quantityAndUnit.charAt(0) == '.') {
                        quantityAndUnit = "0" + quantityAndUnit;
                    }

                    doc.setPage(pagesQuantity * 2 - 1);
                    doc.text(5.5 + xOffset, firstLineYPosition + (currentLine * lineHeight), quantityAndUnit, null, null, "left");
                    doc.setPage(pagesQuantity * 2);
                    doc.text(5.5  + xOffset, firstLineYPosition + (currentLine * lineHeight), quantityAndUnit, null, null, "left");
                    doc.setFont("Gill Sans Std Condensed");

                    //aqui
                    //if product is being supplied by suppliers then draw cirlce
                    if (order[i][5] == "porPesarCamara" || order[i][5] == "yaPesadoCamara") {
                        doc.setPage(pagesQuantity * 2 - 1);
                        drawAsterisk(doc, firstLineYPosition + (currentLine * lineHeight), "blue");
                        doc.setPage(pagesQuantity * 2);
                        drawAsterisk(doc, firstLineYPosition + (currentLine * lineHeight), "blue");
                        nproducts = nproducts + Math.ceil(parseFloat(order[i][1]));
                        ndiversity++;
                        onlyafuera = false;
                    } else if (order[i][5] == "porPesarAfuera" || order[i][5] == "yaPesadoAfuera") {
                        doc.setPage(pagesQuantity * 2 - 1);
                        drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "red");
                        doc.setPage(pagesQuantity * 2);
                        drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "red");
                        nproducts = nproducts + Math.ceil(parseFloat(order[i][1]));
                        ndiversity++;
                    }

                    if(order[i][0] == "QU")
                        haspanela = true;

                    if(order[i][0] == "ACL20")
                        hasBidon = true;

                    if(order[i][0] == "CHN" || order[i][0] == "QUMI" || order[i][0] == "QUGI" || order[i][0] == "CHP")
                        hasChuletaN = true;

                    //product price * quantity
                    doc.setFont("Gill Sans MT Condensed Negrita");
                    doc.setFontSize(12.5);
                    product = JSON.search(products, '//*[clave="' + order[i][0] + '"]');
                    var totalProduct = roundDecimals(Math.round(product[0].costo * order[i][1] * 10) / 10);
                    if (order[i][5] != "porPesarCamara" && order[i][5] != "porPesarAfuera") {
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(115 + xOffset, firstLineYPosition + (currentLine * lineHeight), totalProduct.toLocaleString('en-US'), null, null, "left");
                        doc.setPage(pagesQuantity * 2);
                        doc.text(115 + xOffset, firstLineYPosition + (currentLine * lineHeight), totalProduct.toLocaleString('en-US'), null, null, "left");
                    } else {
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(115 + xOffset, firstLineYPosition + (currentLine * lineHeight), totalProduct.toLocaleString('en-US'));
                        doc.setDrawColor(255, 0, 0);
                        doc.line(128 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 135  + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setDrawColor(0, 0, 0);

                        doc.setPage(pagesQuantity * 2);
                        doc.text(115 + xOffset, firstLineYPosition + (currentLine * lineHeight), totalProduct.toLocaleString('en-US'));
                        doc.setDrawColor(255, 0, 0);
                        doc.line(128 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 135 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setDrawColor(0, 0, 0);
                    }
                    
                    //calculating current total
                    var productTotal;
                    if (order[i][1] < 0)
                        productTotal = product[0].costo * order[i][1] * (-1);
                    else
                        productTotal = product[0].costo * order[i][1];
                    
                    total += productTotal;
                    category += (productTotal * categories[order[i][8]]);

                    //notes and description
                    doc.setFont("Gill Sans MT Condensed Negrita");

                    //if no connection then sign aJamones and aCremas products
                    //FIX huge if
                    var aJamonesSpecialProducts = ["RET", "SA", "JAI", "TOI", "JAAA", "JAAN", "JAAR", "JAI", "JAYI", "JAPF", "JAHV", "JAPA", "JPA", "JAA"];
                    if (order[i][5] == "aCremas" || order[i][5] == "aJamones" || aJamonesSpecialProducts.includes(order[i][0]) && order[i][4] != "" || aJamonesSpecialProducts.includes(order[i][0]) && order[i][1] % 1 != 0)
                        if(document.getElementById("noConnectionAlert").style.display == "block")
                            order[i][4] = "-ANOTAR- " + order[i][4];
                    if (order[i][4] != "") {
                        //notes and description
                        doc.setFontSize(10);
                        doc.setPage(pagesQuantity * 2 - 1);

                        doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight) + 1.5, replaceAEIOUN(order[i][4]));
                        doc.setPage(pagesQuantity * 2);
                        doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight) + 1.5, replaceAEIOUN(order[i][4]));

                        doc.setFontSize(12.5);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight) - 1.5, replaceAEIOUN(order[i][3]));
                        doc.setPage(pagesQuantity * 2);
                        doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight) - 1.5, replaceAEIOUN(order[i][3]));
                    } else {
                        //just description
                        doc.setFontSize(12.5);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight), replaceAEIOUN(order[i][3]));
                        doc.setPage(pagesQuantity * 2);
                        doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight), replaceAEIOUN(order[i][3]));
                    }

                    //drawline if product needs to be weighted
                    if (order[i][5] == "porPesarCamara" || order[i][5] == "porPesarAfuera") {
                        calculable = false;
                        doc.setLineWidth(0.35);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.setDrawColor(255, 0, 0);
                        doc.line(93 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 110 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setPage(pagesQuantity * 2);
                        doc.setDrawColor(255, 0, 0);
                        doc.line(93 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 110 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setDrawColor(0, 0, 0);
                    }

                    //send to cremas or jamones with index. some jamones are detected automatically
                    if (order[i][5] == "aCremas")
                        withPendingProducts = aCremasOrder(order[i], i);
                    else if (order[i][5] == "aJamones")
                        withPendingProducts = aJamonesOrder(order[i], i);
                    else if (order[i][5] == "aBodega")
                        withPendingProducts = aBodegaOrder(order[i], i);
                    else if (order[i][5] == "aBodegaAbajo")
                        withPendingProducts = aBodegaAbajoOrder(order[i], i);
                    else if (aJamonesSpecialProducts.includes(order[i][0]) && order[i][4] != "") 
                        withPendingProducts = aJamonesOrder(order[i], i);
                    else if (aJamonesSpecialProducts.includes(order[i][0]) && order[i][1] % 1 != 0) {
                        var tempProduct = order[i];
                        tempProduct[1] = ((order[i][1] * 100) % 100) / 100;
                        withPendingProducts = aJamonesOrder(tempProduct, i);
                    }
                    currentLine++;
                }
                
                if(hasBidon) {
                    if((order.length % 17) != 0 && (order.length % 17) != 16) {
                        doc.setFontSize(12.5);
                        doc.setFont("Gill Sans MT Condensed Negrita");
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(68.5 + xOffset, 184  + yOffset, "RECUERDA TRAER TUS ENVASES VACIOS DE ACEITE", "center");
                        doc.text(68.5 + xOffset, 189  + yOffset, "SON $10 PESOS DE IMPROTE", "center");
                        doc.setPage(pagesQuantity * 2);
                        doc.text(68.5 + xOffset, 184  + yOffset, "RECUERDA TRAER TUS ENVASES VACIOS DE ACEITE", "center");
                        doc.text(68.5 + xOffset, 189  + yOffset, "SON $10 PESOS DE IMPROTE", "center");
                    }
                }else if(orderMethod == "MOSTRADOR") {
                    if((order.length % 17) != 0 && (order.length % 17) != 16) {
                        doc.setFontSize(12.5);
                        doc.setFont("Gill Sans MT Condensed Negrita");
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(68.5 + xOffset, 179  + yOffset, "RECUERDA QUE YA PUEDES HACER TU PEDIDO ANTES DE VENIR", "center");
                        doc.text(68.5 + xOffset, 184  + yOffset, "POR WHATSAPP: 333317050598 O TELEFONO: 3336713915", "center");
                        doc.text(68.5 + xOffset, 189  + yOffset, "Y PASAS DIRECTO A PAGAR Y RECOGER.", "center");
                        doc.setPage(pagesQuantity * 2);
                        doc.text(68.5 + xOffset, 179  + yOffset, "RECUERDA QUE YA PUEDES HACER TU PEDIDO ANTES DE VENIR", "center");
                        doc.text(68.5 + xOffset, 184  + yOffset, "POR WHATSAPP: 333317050598 O TELEFONO: 3336713915", "center");
                        doc.text(68.5 + xOffset, 189  + yOffset, "Y PASAS DIRECTO A PAGAR Y RECOGER.", "center");
                    }
                }

                //if calculable then total
                doc.setFont("Gill Sans MT Condensed Negrita");
                doc.setFontSize(25);
                total = roundDecimals(Math.round(total * 10) / 10);
                if ((total / 1000) >= 1)
                    total = total.toLocaleString('en-US')
                else
                    total = total.toString();

                if (calculable) {
                    doc.setPage(pagesQuantity * 2 - 1);
                    doc.text(129.5 + xOffset, 209  + yOffset, "TOTAL  " + total.toLocaleString('en-US'), "right");
                    //doc.setDrawColor(0, 0, 0);
                    //doc.line(102 + xOffset, 194.5  + yOffset, 135 + xOffset, 194.5  + yOffset);
                    doc.setPage(pagesQuantity * 2);
                    doc.text(129.5 + xOffset, 209  + yOffset, "TOTAL  " + total.toLocaleString('en-US'), "right");
                    //doc.line(102 + xOffset, 194.5  + yOffset, 135 + xOffset, 194.5  + yOffset);

                    //generates QR code with total embeded in
                    for(var i = 1; i <= pagesQuantity * 2; i++) {
                        doc.setPage(i);
                        productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                        doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194  + yOffset, 15, 15);
                    }
                } else {
                    doc.setPage(pagesQuantity * 2 - 1);
                    doc.text(129.5 + xOffset, 200  + yOffset, "APROX  " + total.toLocaleString('en-US'), "right");
                    doc.setPage(pagesQuantity * 2);
                    doc.text(129.5 + xOffset, 200  + yOffset, "APROX  " + total.toLocaleString('en-US'), "right");

                    //generates QR code with total embeded in
                    for(var i = 1; i <= pagesQuantity * 2; i++) {
                        doc.setPage(i);
                        productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                        doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194  + yOffset, 15, 15);
                    }
                }
                
                //category
                var points = "";
                doc.setPage(1);
                doc.setFontSize(10);
                if (category >= 50 && category < 100) points = ".";
                else if(category >= 100 && category < 150) points = "..";
                else if(category >= 150 && category < 200) points = "...";
                else if(category >= 200 && category < 250) points = "....";
                else if(category >= 250 && category < 300) points = ".....";
                else if(category >= 300 && category < 350) points = "......";
                else if(category >= 350 && category < 400) points = ".......";
                else if(category >= 400 && category < 450) points = "........";
                else if(category >= 450 && category < 500) points = ".........";
                else if(category >= 550 && category < 600) points = "..........";
                else if(category >= 600 && category < 650) points = "...........";
                else if(category >= 650) points = "............";

                for(var i = 1; i <= pagesQuantity * 2; i++) {
                    doc.setPage(i);
                    doc.text(27 + xOffset, 210  + yOffset, points, "left");
                }

                //aqui
                var justNameFlag = false;
                if(((ndiversity <= 2 && !hasChuletaN) && orderMethod == "MOSTRADOR") || ((ndiversity == 0 && !hasChuletaN) && orderMethod != "MOSTRADOR")) {
                    doc.setPage(1);
                    doc.setFontSize(29);
                    doc.setFont("Gill Sans MT Condensed Negrita");
                    doc.text(123 + xOffset, 41.5  + yOffset, ">", "center");
                    doc.setPage(2);
                    doc.setFontSize(29);
                    doc.setFont("Gill Sans MT Condensed Negrita");
                    doc.text(123 + xOffset, 41.5  + yOffset, ">", "center");
                    justNameFlag = true;

                    /* OUTDATED
                    firebase.database().ref('process/justName/' + productsRefID.replace(/[^A-Z0-9]/g,'')).set({
                        name: replaceAEIOUN($("#inputName").val().trim())
                    });
                    */
                }

                if($("#sugerenciasLabel").css("visibility") == "visible")
                    uploadSugReasons(clientName, clientNumber);
                
                //set pending products id (the one embeded in the qr code)
                if(withPendingProducts)
                    firebase.database().ref('pendingOrders/' + orderRefID + '/id').set(productsRefID);
                else
                    firebase.database().ref('pendingOrders/' + orderRefID).remove();

                if ($("#invoiceCheckbox").is(':checked'))
                    uploadCompleteOrder(replaceAEIOUN($("#inputName").val().trim()), order, total, productsRefID);

                //autoprints PDF in a new tab
                doc.autoPrint();

                if(window.open(doc.output('bloburl'), '_blank') != null) { 
                    console.log("imprimi"); 
                    var ncomputer = globalComputer.slice(-1);
                    var etime = calculateWTime(Math.ceil(nproducts));
                    
                    //process
                    firebase.database().ref('process/firsts/' + productsRefID.replace(/[^A-Z0-9]/g,'')).set({
                        name: replaceAEIOUN($("#inputName").val().trim()),
                        total: total,
                        hour: Date.now(),
                        nproducts: nproducts,
                        ndiversity: ndiversity,
                        haspanela: hasChuletaN,
                        onlyafuera: onlyafuera,
                        femployee: replaceAEIOUN($("#inputEmployeeName").val()),
                        iftomorrow: iftomorrow,
                        ordertype: ordertype,
                        ftotal: calculable,
                        ncomputer: ncomputer,
                        etime: etime,
                        justName: justNameFlag
                    });
                    
                    /*
                    //whatsapp
                    uploadSuggestedOrder(clientNumber, sOrderProducts, total);
                    if(clientNumber != "" && clientNumber.charAt(0) != "0") {
                        firebase.database().ref('process/whatsapp/' + productsRefID.replace(/[^A-Z0-9]/g,'')).set({
                            name: clientName,
                            total: total,
                            hour: Date.now(),
                            iftomorrow: iftomorrow,
                            number: clientNumber,
                            etime: etime,
                            stage: 0
                        });
                    }
                    */
                    
                    //survey values
                    //increaseEmployeeCounter($("#inputEmployeeName").val());
                    //uploadSurvey(surveyValues);
                    
                    console.log("voy borrar orden");
                    eraseOrder();
                    console.log("ya borré orden");
                    
                    firebase.database().ref(globalComputer + '/wtime').set(etime);
                    finishOrderProducts(true);
                }
            }
        }

        function deleteSuggestedProduct(id) {
            $("#dynamic-list-2").find("[data-id='" + id + "']").remove();
            if($("#dynamic-list-2").children().length == 0)
                hideSugList();
        }

        function populateSuggestedOrder(number) {
            databaseClients.child(number + "/sug").once('value', function (snapshot) {
                if(snapshot.val() != null) {
                    $("#dynamic-list-2").empty();
                    $("#dynamic-list-2").css("opacity", "1");
                    formatSuggestedOrder(snapshot.val());
                    showSugList();
                }
            });
        }

        function populateSuggestedOrderLV(number) {
            databaseClients.child(number + "/sug").once('value', function (snapshot) {
                if(snapshot.val() != null) {
                    formatSuggestedOrderLV(snapshot.val());
                }
            });
        }

        function formatSuggestedOrder(sorder) {
            var sorder = Object.fromEntries(
                Object.entries(sorder).sort(function(a, b) {
                    return a[1].f - b[1].f;
                })
            );

            for (const [key, value] of Object.entries(sorder)) {
                var searchResult = JSON.search(products, '//*[clave="' + key + '"]');
                if(searchResult[0] != null)
                    populateSuggestedProduct(searchResult[0], value["uc"], value["n"]);
            }
        }

        function formatSuggestedOrderLV(sorder) {
            var sorder = Object.fromEntries(
                Object.entries(sorder).sort(function(a, b) {
                    return a[1].f - b[1].f;
                })
            );

            var sOrderObject = {};
            for (const [key, value] of Object.entries(sorder)) {
                var searchResult = JSON.search(products, '//*[clave="' + key + '"]');
                var sProducts = {};
                if(searchResult[0] != null) {
                    sProducts.cantidad = value["uc"];
                    sProducts.descripcion = searchResult[0].descripcion;
                    sProducts.existencia = searchResult[0].existencia;
                    if(value["n"] == undefined) sProducts.notas = "";
                    else sProducts.notas = value["n"];
                    sProducts.precio = searchResult[0].costo;
                    sProducts.tipo = searchResult[0].tipo;
                    sProducts.unidad = searchResult[0].unidad;
                }
                sOrderObject[key] = sProducts;
            }
            firebase.database().ref(globalComputer + '/sorder').set(sOrderObject);
        }

        function addProductObjectGetterS(id, quantity, note) {
            var searchResult = JSON.search(products, '//*[clave="' + id + '"]');
            addProduct(searchResult[0]);
            var firstInput = $('#dynamic-list').find('input').first();
            firstInput.val(quantity);
            $('#dynamic-list').find('input').eq(1).val(note);
            
            $('#dynamic-list').children().first().data("total", (round(quantity * searchResult[0].costo)));
            $('#dynamic-list').children().first().children().eq(3).text("$" + round(quantity * searchResult[0].costo));
            updateTotal();

            firstInput.focus();
        }

        function populateSuggestedProduct(product, quantity, note) {
            var color,
            backgroundColor;
            if(product.existencia == "siHay") {
                color = "#EEEEEE";
                backgroundColor = "#111111";
            } else if(product.existencia == "noHay") {
                color = "rgba(216, 61, 52, 95%)";
                backgroundColor = "#111111";
            } else if(product.existencia == "pedido") {
                color = "rgba(51, 204, 51, 80%)";
                backgroundColor = "#111111";
            }
            
            if(note == undefined)
                note = "";

            //onclick="addProductObjectGetterS(&#39;' + product.clave + '&#39;, &#39;' + quantity + '&#39;, &#39;' + note + '&#39;)"
            var productListItem =
                '<div class="list-group-item row product-row" data-id="' + product.clave + '" data-total="' + round(quantity * product.costo) + '" style="background-color: ' + backgroundColor + '; color: ' + color + '; border-color: #555555; line-height: 37px;">' +
                    '<button class="col-sm-1 product-quantity" onclick="addProductObjectGetterS(&#39;' + product.clave + '&#39;, &#39;' + quantity + '&#39;, &#39;' + note + '&#39;)" style="text-align: left; padding-left: 13px; height: 35px; background-color: ' + backgroundColor + '; border: none;">' + quantity + '</button>' +
                    '<button class="col-sm-1 product-info" onclick="addProductObjectGetterS(&#39;' + product.clave + '&#39;, &#39;' + quantity + '&#39;, &#39;' + note + '&#39;)" style="text-align: left; padding-top: 0px; height: 35px; background-color: ' + backgroundColor + '; border: none;">' + product.unidad + '</button>' +
                    '<button class="col-sm-6 product-info" onclick="addProductObjectGetterS(&#39;' + product.clave + '&#39;, &#39;' + quantity + '&#39;, &#39;' + note + '&#39;)" style="text-align: left; padding-top: 0px; height: 35px; background-color: ' + backgroundColor + '; border: none;">' + product.descripcion + '</button>' +
                    '<button class="col-sm-2 product-info" onclick="addProductObjectGetterS(&#39;' + product.clave + '&#39;, &#39;' + quantity + '&#39;, &#39;' + note + '&#39;)" style="text-align: left; padding-top: 0px; height: 35px; background-color: ' + backgroundColor + '; border: none;">' + note + '</button>' +
                    '<div class="col-sm-2 product-notes-container">' +
                        '<input type="input" oninput="this.value = this.value.toUpperCase()" style= "color: ' + color + '; background-color: ' + backgroundColor + '; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-right: 0px; padding-bottom: 0px; line-height: 4px;" class="form-control product-notes" maxlength="48" placeholder="MOTIVO"> </input>' +
                    '</div>' +
                '</div>';

            $('#dynamic-list-2').prepend(productListItem);            
        }
        
        //guardo registro de los productos que lleva el cliente
        function uploadSuggestedOrder(number, sOrderProducts, total) {
            databaseClients.child(number + "/uvisita").set(Date.now());

            total = total.replace(/\,/g,'');
            databaseClients.child(number + "/agr").once('value', function (snapshot) {
                if(snapshot.val() == null) {
                    databaseClients.child(number + "/agr").set(total);
                } else {
                    databaseClients.child(number + "/agr").set(parseInt(snapshot.val()) + parseInt(total));
                }
            });

            for (const [key, value] of Object.entries(sOrderProducts)) {
                databaseClients.child(number + "/sug/" + key + "/uc").set(value.uc);
                if(value.n != "")
                    databaseClients.child(number + "/sug/" + key + "/n").set(value.n);
                
                databaseClients.child(number + "/sug/" + key + "/f").once('value', function(snapshot) {
                    if(snapshot.val() == null) databaseClients.child(number + "/sug/" + key + "/f").set(1);
                    else databaseClients.child(number + "/sug/" + key + "/f").set(snapshot.val() + 1);
                });
            }
        }
        
        function calculateWTime(nproducts) {
            var wtime;
            if(nproducts <= 10)
                wtime = nproducts * globalTPP[0];
            else if(nproducts <= 30)
                wtime = nproducts * globalTPP[1];
            else
                wtime = nproducts * globalTPP[2];

            wtime = wtime + (globalWaitingOrders * 1.5);

            if(!wtime)
                return "-";

            return Math.ceil(wtime);
        }

        function populateWaitingTimes() {
            firebase.database().ref('process/timing').on('value', function (snapshot) {
                if(snapshot.val()) {
                    globalWaitingOrders = snapshot.val().worders;
                    if(snapshot.val().tpp10 != undefined && snapshot.val().tpp30 != undefined && snapshot.val().tpp50 != undefined)
                        globalTPP = [snapshot.val().tpp10, snapshot.val().tpp30, snapshot.val().tpp50];
                    else
                        globalTPP = ["0.55", "0.45", "0.35"];
                    updateWT();
                }
            });
        }

        function uploadCompleteOrder(name, products, total, id) {
            id = id.replace(".", "").replace(" ", "");
            total = total.replace(/\,/g,'');

            for(var i = 0; i < products.length; i++)
                products[i] = products[i].map(v => v === undefined ? '1' : v);
            
            firebase.database().ref("invoice/" + id).set({
                nombre: name,
                productos: products,
                subtotal: total
            });
        }

        function increaseEmployeeCounter(employee) {
            firebase.database().ref("registro/" + employee + "/pedidos").once('value', function(snapshot) {
                if(snapshot.val() == null)
                    firebase.database().ref("registro/" + employee + "/pedidos").set(1);
                else
                    firebase.database().ref("registro/" + employee + "/pedidos").set(snapshot.val() + 1);
            });
        }

        function increaseEmployeeCounterPhone(employee) {
            firebase.database().ref("registro/" + employee + "/pedidosTelefonicos").once('value', function(snapshot) {
                if(snapshot.val() == null)
                    firebase.database().ref("registro/" + employee + "/pedidosTelefonicos").set(1);
                else
                    firebase.database().ref("registro/" + employee + "/pedidosTelefonicos").set(snapshot.val() + 1);
            });
        }

        function roundDecimals(number) {
            return Math.round(number * 2) / 2;
        }

        function round(number) {
            return Math.round((number * 1 + Number.EPSILON) * 100) / 100;
        }

        //adds a new page with all the values
        function addPagePDF(doc, orderMethod, length) {
            doc.addPage();
            addTimePDF(doc);
            addNamePDF(doc, length);
            addMethodPDF(doc, orderMethod);
        }

        //adds date and time to the top right corner
        function addTimePDF(doc) {
            doc.setFontSize(12.5);
            doc.setFont("Gill Sans MT Condensed Negrita");

            var date = new Date();
            var months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
            var fullDate = date.getDate().toString() + " / " + months[date.getMonth()] + " / " + date.getFullYear().toString();
            doc.text(19.9 + xOffset, 30 + yOffset, fullDate, 'center');

            var hourWithMinutes = new Date().toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            doc.text(53.5  + xOffset, 30  + yOffset, hourWithMinutes, 'center');
        }

        function addMethodPDF(doc, orderMethod) {
            doc.setFontSize(12.5);
            doc.setFont("Gill Sans MT Condensed Negrita");

            //special mark if the order is for the next day
            if ($("#tomorrowCheckbox").is(':checked')) {
                doc.setFontSize(29);
                doc.text(9 + xOffset, 41.5  + yOffset, "M", "center");
                doc.setFontSize(12.5);
                //revisar
                doc.text(68 + xOffset, 196.9  + yOffset, "MANANA");
                doc.setFontSize(12.5);
            }

            doc.text(84 + xOffset, 30  + yOffset, orderMethod, 'center');

            //special counter if the order was made by phone
            if(event.srcElement.id == "printByPhoneButton") {
                //increaseEmployeeCounterPhone($("#inputEmployeeName").val());
                firebase.database().ref(globalComputer + '/phoneOrder').set(true);
            }

            if ($("#invoiceCheckbox").is(':checked')) {
                doc.setFontSize(29);
                doc.setFont("Gill Sans MT Condensed Negrita");
                doc.text(129 + xOffset, 41.5  + yOffset, "F", "center");
            }
        }

        //adds the name
        function addNamePDF(doc, length) {
            var name = $("#inputName").val().trim();

            doc.setFontSize(29);
            doc.setFont("Gill Sans MT Condensed Negrita");
            doc.text(68.5 + xOffset, 41.5  + yOffset, replaceAEIOUN(name), "center");

            doc.setFontSize(12.5);
            doc.setFont("Gill Sans MT Condensed Negrita");
            doc.text(27 + xOffset, 196.9  + yOffset, "ANOTO: " + replaceAEIOUN($("#inputEmployeeName").val()) + " C" + globalComputer.slice(-1) + " #" + length);
            doc.text(27 + xOffset, 202.95  + yOffset, "SURTIO: ");
            doc.text(27 + xOffset, 209  + yOffset, "ENTREGO: ");
        }

        //draws circle besides the description        
        function drawCricle(doc, YCoordinate, validColor) {
            if (validColor == "blue")
                doc.text(4.5 + xOffset, YCoordinate - 1.5, "+", "center");
            else if (validColor == "red")
                doc.text(4.5 + xOffset, YCoordinate - .7, "-", "center");

            //doc.circle(5 + xOffset, YCoordinate - 1.7, .8, 'F');
        }

        function drawAsterisk(doc, YCoordinate, validColor) {
            if (validColor == "blue")
                doc.setFillColor(0, 0, 255);
            else if (validColor == "red")
                doc.setFillColor(255, 0, 0);

            doc.text(4.5  + xOffset, YCoordinate + 1, "*", null, null, "center");
        }

        //replaces special characters (current jspdf doesn´t support them)
        function replaceAEIOUN(string) {
            string = string.replace(/á/gi, "A");
            string = string.replace(/é/gi, "E");
            string = string.replace(/í/gi, "I");
            string = string.replace(/ó/gi, "O");
            string = string.replace(/ú/gi, "U");
            string = string.replace(/ñ/gi, "N");
            return string;
        }

        //generates a new QR code at the bottom left of the PDF, return a dataURL
        function generateQR(name) {
            name = name.replace("Ñ", "NN");
            document.getElementById('qrcode').innerHTML = "";
            var qrcode = new QRCode("qrcode", {
                text: name,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
            console.log(name);
            qrid = name;
            var canvas = document.getElementById('qrcode').querySelector('canvas');
            return canvas.toDataURL();
        }

        //uploads or updates an order product
        function uploadOrderProduct(date, quantity, unit, description, notes, price, stock, type, id) {
            firebase.database().ref(globalComputer + '/order/' + date).set({
                cantidad: quantity,
                unidad: unit,
                descripcion: description,
                notas: notes,
                precio: price,
                existencia: stock,
                tipo: type,
                clave: id
            });
        }

        function joinRepeatedProducts(surveyValues) {
            result = [];
            surveyValues.forEach(function (a) {
                if (!this[a[0]]) {
                    this[a[0]] = [a[0], 0];
                    result.push(this[a[0]]);
                }
                this[a[0]][1] += parseInt(Math.trunc(a[1] * 100), 10);
            }, Object.create(null));
            return result;
        }

        function uploadSurvey(surveyValues) {
            surveyValues = joinRepeatedProducts(surveyValues);
            for (var i = 0; i < surveyValues.length; i++) {
                let key = toAES(surveyValues[i][0]);
                let sale = surveyValues[i][1];
                firebase.database().ref('survey/' + key).once('value', function(snapshot) {
                    var aes = snapshot.key;
                    var current = snapshot.val();
                    var num = parseInt(current, 16) + sale;
                    
                    firebase.database().ref('survey/' + aes).set(num.toString(16));
                });
            }
        }

        function toAES(string) {
            return aesjs.utils.hex.fromBytes(aesEcb.encrypt(aesjs.utils.utf8.toBytes(to16Bytes(string))));
        }

        function to16Bytes(string) {
            return string + " ".repeat(16 - string.length);
        }

        function updateName(name) {
            firebase.database().ref(globalComputer + '/name').set(name);
        }

        function updateEmployee(employee) {
            firebase.database().ref(globalComputer + '/employee').set(employee);
        }

        function updateOrderProductNotes(date, notes) {
            firebase.database().ref(globalComputer + '/order/' + date + "/notas").set(notes);
        }

        function updateOrderProductQuantity(date, quantity) {
            firebase.database().ref(globalComputer + '/order/' + date + "/cantidad").set(quantity);
        }

        function removeOrderProduct(date) {
            firebase.database().ref(globalComputer + '/order/' + date).remove();
        }

        function removeOrderProducts() {
            firebase.database().ref(globalComputer).remove();
            finishOrderProducts(false);
        }

        function finishOrderProducts(isDone) {
            firebase.database().ref(globalComputer + '/done').set(isDone);
        }

        function createNameDB(name) {
            var orderRef = firebase.database().ref('pendingOrders').push({ name: name });
            orderRefID = orderRef.key;
        }

        //uploads the aCremas product
        function aCremasOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];
            
            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aCremas').push(productJSON);
            firebase.database().ref('aCremas/pendientes/' + productRef.key ).set(productJSON);
            return true;
        }

        //uploads the aJamones product
        function aJamonesOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];
            
            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aJamones').push(productJSON);
            firebase.database().ref('aJamones/pendientes/' + productRef.key ).set(productJSON);
            return true;
        }

        //uploads the aBodega product
        function aBodegaOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];
            
            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aBodega').push(productJSON);
            firebase.database().ref('aBodega/pendientes/' + productRef.key ).set(productJSON);
            return true;
        }

        //uploads the arriba product
        function aBodegaAbajoOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];
            
            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aBodegaAbajo').push(productJSON);
            firebase.database().ref('aBodegaAbajo/pendientes/' + productRef.key ).set(productJSON);
            return true;
        }

        //leaves the page ready for a new order
        function eraseOrder() {
            $("#inputName").val("");
            $("#dynamic-list").html("");
            $("#dynamic-list-2").html("");
            hideSugList();
            $('#tomorrowCheckbox').prop('checked', false);
            $('#invoiceCheckbox').prop('checked', false);
            $("#totalTextField").text("$0");
            $("#greenCheck").css("visibility", "hidden");
            $("#greenCheckW").css("visibility", "hidden");
            $("#greenCheckWN").css("visibility", "hidden");
            firebase.database().ref(globalComputer + '/sorder').remove();
            clientName = "";
            clientNumber = "";
            updateWT();
            productsCounter = 0;
            updateNP(productsCounter);
        }

        //checks current connection status
        function checkConnection() {
            var printButton = document.getElementById("printButton");
            var connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", function (snap) {
                if (snap.val() === true)
                    document.getElementById("noConnectionAlert").style.display = "none";
                else
                    document.getElementById("noConnectionAlert").style.display = "block";

            });
        }

        //starts listening to connection stauts
        checkConnection();
        populateWaitingTimes();

        //removes any products from the live view
        removeOrderProducts();

        //some shortcuts. get the keycodes from here http://keycode.info
        $(document).keydown(function (e) {
            if (e.keyCode == 221 || e.keyCode == 106)
                generatePDF("");
            else if (e.keyCode == 219 || e.keyCode == 111) {
                $("#inputName").focus();
                setTimeout(function () {
                    $("#inputName").val($("#inputName").val().substring(0, $("#inputName").val().length - 1));
                }, 100);
            }
        });

    </script>
</body>